(function(e){"use strict";function X(e,t,n){this.pgn=e,this.index=t,this[h]=n;for(var r=3;r<arguments[p];++r){var i=new RegExp("%"+(r-2)+"\\$s");this[h]=this[h][d](i,arguments[r])}}function V(t,n){this[v]=t,this._next=m,this[g]=new e.Position(t[y]());if(n===b){this[w]=b;if(!this[g].playNullMove())throw new e[S][E](this[g],b,W[r])}else{var i=t[y]().notation(n);this[w]=this[g].notation(i),this[g].play(i)}this[x]=t[y]().turn(),t instanceof $?this[T]=t[v][T]:this[T]=this[x]==="w"?t[T]+1:t[T],this[N]=t[N],this[C]=[],this[k]=[],this[L]=m,this[A]=O,t instanceof $?t[M]=this:t._next=this}function $(e,t){this[v]=e,this[M]=m,this[N]=t,this[k]=[],this[L]=m,this[A]=O,e instanceof J?e[B]=this:e[C][j](this)}function J(){this[I]={},this[q]=new e.Position,this[T]=1,this[R]="*",new $(this,!0)}function rt(r){function b(){var e=0;while(l<r[p]){var t=r.substr(l);if(/^([ \f\t\v])+/[z](t))l+=RegExp.$1[p];else{if(!/^(\r?\n|\r)/[z](t))break;l+=RegExp.$1[p],++e}}c=e>=2}function w(){b();if(l>=r[p])return O;var e=r.substr(l),n=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/[z](e))n=RegExp.$1[p],v=Q,g={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?|--))/[z](e))n=RegExp.$1[p],v=G,g=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf)|\$([1-9][0-9]*))/[z](e))n=RegExp.$1[p],v=Y,g=RegExp.$3[p]===0?K[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/[z](e))n=RegExp.$1[p],v=Z,g=RegExp.$2[d](/\\(\\|\{|\})/g,"$1")[d](/^\s+|\s+$/g,"");else if(/^(\()/[z](e))n=RegExp.$1[p],v=et,g=m;else if(/^(\))/[z](e))n=RegExp.$1[p],v=tt,g=m;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/[z](e))throw new X(r,l,W[t]);n=RegExp.$1[p],v=nt,g=RegExp.$1}return y=l,l+=n,!0}var l=0,c=O,v=0,g=m,y=0,x=[],C=m,M=m,_=[];while(w()){C===m&&(C=new J),v!==Q&&M===m&&(M=C[U]());switch(v){case Q:if(M!==m)throw new X(r,y,W[s]);C[I][g.key]=g.value;if(g.key==="FEN")try{var D=C[q].fen(g.value);C[T]=D[P]}catch(H){throw H instanceof e[S].InvalidFEN?new X(r,y,W[i],H[h]):H}break;case G:try{M=new V(M,g)}catch(H){throw H instanceof e[S][E]?new X(r,y,W[n],H[h]):H}break;case Y:M[k][j](g);break;case Z:M[L]=g,M[A]=M[N]&&c;break;case et:if(!(M instanceof V))throw new X(r,y,W[o]);_[j](M),M=new $(M,M[N]&&c);break;case tt:if(_[p]===0)throw new X(r,y,W[u]);M=_.pop();break;case nt:if(_[p]>0)throw new X(r,y,W[a]);C[R]=g,x[j](C),C=m,M=m}}if(C!==m)throw new X(r,r[p],W[f]);return x}function it(e){var t=rt(e);switch(t[p]){case 0:throw new X(e,-1,W[l]);case 1:return t[0];default:throw new X(e,-1,W[c])}}var t="INVALID_PGN_TOKEN",n="INVALID_MOVE_IN_PGN_TEXT",r="INVALID_NULL_MOVE_IN_PGN_TEXT",i="INVALID_FEN_IN_PGN_TEXT",s="UNEXPECTED_PGN_HEADER",o="UNEXPECTED_BEGIN_OF_VARIATION",u="UNEXPECTED_END_OF_VARIATION",a="UNEXPECTED_END_OF_GAME",f="UNEXPECTED_END_OF_TEXT",l="PGN_TEXT_IS_EMPTY",c="PGN_TEXT_CONTAINS_SEVERAL_GAMES",h="message",p="length",d="replace",v="_parent",m=null,g="_position",y="position",b="--",w="_notation",E="InvalidNotation",S="exceptions",x="_movingColor",T="_fullMoveNumber",N="_withinLongVariation",C="_variations",k="_nags",L="_comment",A="_isLongComment",O=!1,M="_first",_="prototype",D="positionBefore",P="fullMoveNumber",H="isLongComment",B="_mainVariation",j="push",F="initialPosition",I="_headers",q="_initialPosition",R="_result",U="mainVariation",z="test",W=e.i18n;W[t]="Unrecognized character or group of characters.",W[n]="Invalid move. %1$s",W[r]="Invalid null-move.",W[i]="Invalid FEN string in the initial position header. %1$s",W[s]="Unexpected PGN item header.",W[o]="Unexpected begin of variation.",W[u]="Unexpected end of variation.",W[a]="Unexpected end of game: there are pending variations.",W[f]="Unexpected end of text: there is a pending item.",W[l]="No game found in the text.",W[c]="The PGN data contains 2 or more games.",V[_].move=function(){return this[w]},V[_][D]=function(){return this[v][y]()},V[_][y]=function(){return this[g]},V[_][P]=function(){return this[T]},V[_].moveColor=function(){return this[x]},V[_].next=function(){return this._next},V[_].variations=function(){return this[C]},V[_].nags=function(){return this[k]},V[_].comment=function(){return this[L]},V[_][H]=function(){return this[A]},$[_].isLongVariation=function(){return this[N]},$[_][y]=function(){return this[v]instanceof V?this[v][D]():this[v][F]()},$[_].first=function(){return this[M]},$[_].nags=function(){return this[k]},$[_].comment=function(){return this[L]},$[_][H]=function(){return this[A]},J[_].headers=function(){var e=[];for(var t in this[I])this[I].hasOwnProperty(t)&&e[j](t);return e},J[_].header=function(e){var t=this[I][e];return typeof t=="string"?t:m},J[_][F]=function(){return this[q]},J[_][U]=function(){return this[B]},J[_].result=function(){return this[R]};var K={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+=":14,"+/=":14,"=":10,inf:13,"=+":15,"=/+":15,"-/+":17,"-+":19},Q=1,G=2,Y=3,Z=4,et=5,tt=6,nt=7;e[S].InvalidPGN=X,e.pgn={Node:V,Variation:$,Item:J,parse:rt,parseOne:it}})(RPBChess);