(function(e){"use strict";function U(e,t,n){this.pgn=e,this.index=t,this[c]=n;for(var r=3;r<arguments[h];++r){var i=new RegExp("%"+(r-2)+"\\$s");this[c]=this[c][p](i,arguments[r])}}function z(t,n){this[d]=t,this._next=v,this[m]=t[g]().notation(n),this[y]=new e.Position(t[g]()),this[y].play(this[m]),t instanceof W?this[b]=t[d][b]:this[b]=this[m][w]()==="w"?t[b]+1:t[b],this[E]=t[E],this[S]=[],this[x]=[],this[T]=v,this[N]=C,t instanceof W?t[k]=this:t._next=this}function W(e,t){this[d]=e,this[k]=v,this[E]=t,this[x]=[],this[T]=v,this[N]=C,e instanceof X?e[_]=this:e[S][D](this)}function X(){this[H]={},this[B]=new e.Position,this[b]=1,this[j]="*",new W(this,!0)}function et(f){function w(){var e=0;while(l<f[h]){var t=f.substr(l);if(/^([ \f\t\v])+/[I](t))l+=RegExp.$1[h];else{if(!/^(\r?\n|\r)/[I](t))break;l+=RegExp.$1[h],++e}}d=e>=2}function S(){w();if(l>=f[h])return C;var e=f.substr(l),n=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/[I](e))n=RegExp.$1[h],m=$,g={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?))/[I](e))n=RegExp.$1[h],m=J,g=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf)|\$([1-9][0-9]*))/[I](e))n=RegExp.$1[h],m=K,g=RegExp.$3[h]===0?V[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/[I](e))n=RegExp.$1[h],m=Q,g=RegExp.$2[p](/\\(\\|\{|\})/g,"$1")[p](/^\s+|\s+$/g,"");else if(/^(\()/[I](e))n=RegExp.$1[h],m=G,g=v;else if(/^(\))/[I](e))n=RegExp.$1[h],m=Y,g=v;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/[I](e))throw new U(f,l,R[t]);n=RegExp.$1[h],m=Z,g=RegExp.$1}return y=l,l+=n,!0}var l=0,d=C,m=0,g=v,y=0,k=[],L=v,A=v,M=[];while(S()){L===v&&(L=new X),m!==$&&A===v&&(A=L[F]());switch(m){case $:if(A!==v)throw new U(f,y,R[i]);L[H][g.key]=g.value;if(g.key==="FEN")try{var _=L[B].fen(g.value);L[b]=_[O]}catch(P){throw P instanceof e[q].InvalidFEN?new U(f,y,R[r],P[c]):P}break;case J:try{A=new z(A,g)}catch(P){throw P instanceof e[q].InvalidNotation?new U(f,y,R[n],P[c]):P}break;case K:A[x][D](g);break;case Q:A[T]=g,A[N]=A[E]&&d;break;case G:if(!(A instanceof z))throw new U(f,y,R[s]);M[D](A),A=new W(A,A[E]&&d);break;case Y:if(M[h]===0)throw new U(f,y,R[o]);A=M.pop();break;case Z:if(M[h]>0)throw new U(f,y,R[u]);L[j]=g,k[D](L),L=v,A=v}}if(L!==v)throw new U(f,f[h],R[a]);return k}function tt(e){var t=et(e);switch(t[h]){case 0:throw new U(e,-1,R[f]);case 1:return t[0];default:throw new U(e,-1,R[l])}}var t="INVALID_PGN_TOKEN",n="INVALID_MOVE_IN_PGN_TEXT",r="INVALID_FEN_IN_PGN_TEXT",i="UNEXPECTED_PGN_HEADER",s="UNEXPECTED_BEGIN_OF_VARIATION",o="UNEXPECTED_END_OF_VARIATION",u="UNEXPECTED_END_OF_GAME",a="UNEXPECTED_END_OF_TEXT",f="PGN_TEXT_IS_EMPTY",l="PGN_TEXT_CONTAINS_SEVERAL_GAMES",c="message",h="length",p="replace",d="_parent",v=null,m="_move",g="position",y="_position",b="_fullMoveNumber",w="movingColor",E="_withinLongVariation",S="_variations",x="_nags",T="_comment",N="_isLongComment",C=!1,k="_first",L="prototype",A="positionBefore",O="fullMoveNumber",M="isLongComment",_="_mainVariation",D="push",P="initialPosition",H="_headers",B="_initialPosition",j="_result",F="mainVariation",I="test",q="exceptions",R=e.i18n;R[t]="Unrecognized character or group of characters.",R[n]="Invalid move. %1$s",R[r]="Invalid FEN string in the initial position header. %1$s",R[i]="Unexpected PGN item header.",R[s]="Unexpected begin of variation.",R[o]="Unexpected end of variation.",R[u]="Unexpected end of game: there are pending variations.",R[a]="Unexpected end of text: there is a pending item.",R[f]="No game found in the text.",R[l]="The PGN data contains 2 or more games.",z[L].move=function(){return this[A]().notation(this[m])},z[L][A]=function(){return this[d][g]()},z[L][g]=function(){return this[y]},z[L][O]=function(){return this[b]},z[L].moveColor=function(){return this[m][w]()},z[L].next=function(){return this._next},z[L].variations=function(){return this[S]},z[L].nags=function(){return this[x]},z[L].comment=function(){return this[T]},z[L][M]=function(){return this[N]},W[L].isLongVariation=function(){return this[E]},W[L][g]=function(){return this[d]instanceof z?this[d][A]():this[d][P]()},W[L].first=function(){return this[k]},W[L].nags=function(){return this[x]},W[L].comment=function(){return this[T]},W[L][M]=function(){return this[N]},X[L].headers=function(){var e=[];for(var t in this[H])this[H].hasOwnProperty(t)&&e[D](t);return e},X[L].header=function(e){var t=this[H][e];return typeof t=="string"?t:v},X[L][P]=function(){return this[B]},X[L][F]=function(){return this[_]},X[L].result=function(){return this[j]};var V={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+=":14,"+/=":14,"=":10,inf:13,"=+":15,"=/+":15,"-/+":17,"-+":19},$=1,J=2,K=3,Q=4,G=5,Y=6,Z=7;e[q].InvalidPGN=U,e.pgn={Node:z,Variation:W,Item:X,parse:et,parseOne:tt}})(RPBChess);