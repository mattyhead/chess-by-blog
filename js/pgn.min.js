var Pgn=function(e){"use strict";function _(){}function D(t,v){this[o]=t,this._move=v,this[u]=a,this[s]=t[s],this[f]=[];var m=new e(t[l]());this[c]=m.move(v)===a?"":m.fen(),this[h]=t instanceof P?t[p]():t[p]()+1,this[n]=[],this[r]=a,this[i]=d}function P(e,t){this[o]=e,this[w]=a,this[s]=t,this[n]=[],this[r]=a,this[i]=d}function H(){this[x]={},this[T]="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",this[N]=0,this[C]=new P(this,k),this[L]="*"}function B(e,t,n){this.pgnString=e,this.pos=t,this.message=n}function F(e){function v(){var t=0;while(f<e[m]){var n=e.substr(f);if(/^([ \f\t\v])+/[O](n))f+=RegExp.$1[m];else{if(!/^(\r?\n|\r)/[O](n))break;f+=RegExp.$1[m],++t}}l=t>=2}function g(){v();if(f>=e[m])return d;var l=e.substr(f),g=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/[O](l))g=RegExp.$1[m],c=t,h={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBNP]?[a-h]?[1-8]?x?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?))/[O](l))g=RegExp.$1[m],c=n,h=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf)|\$([1-9][0-9]*))/[O](l))g=RegExp.$1[m],c=r,h=RegExp.$3[m]===0?j[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/[O](l))g=RegExp.$1[m],c=i,h=RegExp.$2.replace(/\\(\\|\{|\})/g,"$1").replace(/^\s+|\s+$/g,"");else if(/^(\()/[O](l))g=RegExp.$1[m],c=s,h=a;else if(/^(\))/[O](l))g=RegExp.$1[m],c=o,h=a;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/[O](l))throw new B(e,f,"Unrecognized character or group of characters.");g=RegExp.$1[m],c=u,h=RegExp.$1}return p=f,f+=g,k}var t=1,n=2,r=3,i=4,s=5,o=6,u=7,f=0,l=d,c=0,h=a,p=0,w=[],E=a,S=a,x=[];while(g()){E===a&&(E=new H),c!==t&&S===a&&(S=E[M]());switch(c){case t:if(S!==a)throw new B(e,p,"Unexpected PGN item header.");E.header(h.key,h.value);if(h.key==="FEN"&&!E[A](h.value))throw new B(e,p,"Invalid FEN string.");break;case n:if(!S.play(h))throw new B(e,p,"Invalid move.");S=S instanceof P?S.first():S.next();break;case r:S.nags()[b](h);break;case i:S.comment(h,l);break;case s:if(!(S instanceof D))throw new B(e,p,"Unexpected begin of variation.");x[b](S),S=S[y](l);break;case o:if(x[m]===0)throw new B(e,p,"Unexpected end of variation.");S=x.pop();break;case u:if(x[m]>0)throw new B(e,p,"Unexpected end of game: there are pending variations.");E.result(h),w[b](E),E=a,S=a}}if(E!==a)throw new B(e,e[m],"Unexpected end of text: there is a pending item.");return w}function I(e){var t=Pgn.parse(e);switch(t[m]){case 0:throw new B(e,a,"Unexpected empty PGN data.");case 1:return t[0];default:throw new B(e,a,"The PGN data is expected to contain only one game.")}}var t="prototype",n="_nags",r="_comment",i="_isLongComment",s="_withinLongVariation",o="_parent",u="_next",a=null,f="_variations",l="position",c="_position",h="_moveCounter",p="moveCounter",d=!1,v="constructor",m="length",g="positionBefore",y="addVariation",b="push",w="_first",E="initialPosition",S="initialMoveCounter",x="_headers",T="_initialPosition",N="_initialMoveCounter",C="_mainVariation",k=!0,L="_result",A="defineInitialPosition",O="test",M="mainVariation";_[t].nags=function(e){var t=this[n];return e!==undefined&&(this[n]=e),t},_[t].comment=function(e,t){var n=this[r];return e!==undefined&&(this[r]=e,t!==undefined&&(this[i]=this[s]&&t)),n},_[t].isLongComment=function(){return this[i]},D[t]=new _,D[t][v]=D,D[t].valid=function(){return this[c][m]!==0},D[t].move=function(){return this._move},D[t][g]=function(){return this[o][l]()},D[t][l]=function(){return this[c]},D[t][p]=function(){return this[h]},D[t].fullMoveNumber=function(){return Math.floor(this[h]/2)+1},D[t].moveColor=function(){return this[h]%2===0?"w":"b"},D[t].next=function(){return this[u]},D[t].variations=function(){return this[f][m]},D[t].variation=function(e){return this[f][e]},D[t].play=function(e){return this[u]=new D(this,e),this[u].valid()},D[t][y]=function(e){var t=new P(this,this[s]&&e);return this[f][b](t),t},P[t]=new _,P[t][v]=P,P[t].isLongVariation=function(){return this[s]},P[t][l]=function(){return this[o]instanceof D?this[o][g]():this[o][E]()},P[t][p]=function(){return this[o]instanceof D?this[o][p]():this[o][S]()},P[t].first=function(){return this[w]},P[t].play=function(e){return this[w]=new D(this,e),this[w].valid()},H[t].headers=function(){var e=[];for(var t in this[x])this[x].hasOwnProperty(t)&&e[b](t);return e},H[t].header=function(e,t){var n=e in this[x]?this[x][e]:a;return t!==undefined&&(this[x][e]=t),n},H[t][E]=function(){return this[T]},H[t][S]=function(){return this[N]},H[t][A]=function(t){this[C]=new P(this,k);var n=new e(t);if(n.fen()!==t)return d;if(!/^.* ([0-9]+)\s*$/[O](t))return d;var r=parseInt(RegExp.$1,10);return this[T]=t,this[N]=2*(r-1)+(n.turn()==="w"?0:1),k},H[t][M]=function(){return this[C]},H[t].result=function(e){var t=this[L];if(e!==undefined)switch(e){case"1-0":case"0-1":case"1/2-1/2":case"*":this[L]=e}return t};var j={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+=":14,"+/=":14,"=":10,inf:13,"=+":15,"=/+":15,"-/+":17,"-+":19};return{Node:D,Variation:P,Item:H,Error:B,parse:F,parseOne:I}}(Chess);