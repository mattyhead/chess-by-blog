var Pgn=function(t){"use strict";function n(){}function e(n,e){this._parent=n,this._move=e,this._next=null,this._withinLongVariation=n._withinLongVariation,this._variations=[];var o=new t(n.position());this._position=null===o.move(e)?"":o.fen(),this._moveCounter=n instanceof i?n.moveCounter():n.moveCounter()+1,this._nags=[],this._comment=null,this._isLongComment=!1}function i(t,n){this._parent=t,this._first=null,this._withinLongVariation=n,this._nags=[],this._comment=null,this._isLongComment=!1}function o(){this._headers={},this._initialPosition="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",this._initialMoveCounter=0,this._mainVariation=new i(this,!0),this._result="*"}function r(t,n,e){this.pgnString=t,this.pos=n,this.message=e}function s(t){function n(){for(var n=0;_<t.length;){var e=t.substr(_);if(/^([ \f\t\v])+/.test(e))_+=RegExp.$1.length;else{if(!/^(\r?\n|\r)/.test(e))break;_+=RegExp.$1.length,++n}}v=n>=2}function s(){if(n(),_>=t.length)return!1;var e=t.substr(_),i=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/.test(e))i=RegExp.$1.length,m=a,w={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBNP]?[a-h]?[1-8]?x?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?))/.test(e))i=RegExp.$1.length,m=h,w=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf)|\$([1-9][0-9]*))/.test(e))i=RegExp.$1.length,m=u,w=0===RegExp.$3.length?p[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/.test(e))i=RegExp.$1.length,m=l,w=RegExp.$2.replace(/\\(\\|\{|\})/g,"$1").replace(/^\s+|\s+$/g,"");else if(/^(\()/.test(e))i=RegExp.$1.length,m=f,w=null;else if(/^(\))/.test(e))i=RegExp.$1.length,m=c,w=null;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/.test(e))throw new r(t,_,"Unrecognized character or group of characters.");i=RegExp.$1.length,m=g,w=RegExp.$1}return d=_,_+=i,!0}for(var a=1,h=2,u=3,l=4,f=5,c=6,g=7,_=0,v=!1,m=0,w=null,d=0,y=[],x=null,P=null,R=[];s();)switch(null===x&&(x=new o),m!==a&&null===P&&(P=x.mainVariation()),m){case a:if(null!==P)throw new r(t,d,"Unexpected PGN item header.");if(x.header(w.key,w.value),"FEN"===w.key&&!x.defineInitialPosition(w.value))throw new r(t,d,"Invalid FEN string.");break;case h:if(!P.play(w))throw new r(t,d,"Invalid move.");P=P instanceof i?P.first():P.next();break;case u:P.nags().push(w);break;case l:P.comment(w,v);break;case f:if(!(P instanceof e))throw new r(t,d,"Unexpected begin of variation.");R.push(P),P=P.addVariation(v);break;case c:if(0===R.length)throw new r(t,d,"Unexpected end of variation.");P=R.pop();break;case g:if(R.length>0)throw new r(t,d,"Unexpected end of game: there are pending variations.");x.result(w),y.push(x),x=null,P=null}if(null!==x)throw new r(t,t.length,"Unexpected end of text: there is a pending item.");return y}function a(t){var n=Pgn.parse(t);switch(n.length){case 0:throw new r(t,null,"Unexpected empty PGN data.");case 1:return n[0];default:throw new r(t,null,"The PGN data is expected to contain only one game.")}}n.prototype.nags=function(t){var n=this._nags;return void 0!==t&&(this._nags=t),n},n.prototype.comment=function(t,n){var e=this._comment;return void 0!==t&&(this._comment=t,void 0!==n&&(this._isLongComment=this._withinLongVariation&&n)),e},n.prototype.isLongComment=function(){return this._isLongComment},e.prototype=new n,e.prototype.constructor=e,e.prototype.valid=function(){return 0!==this._position.length},e.prototype.move=function(){return this._move},e.prototype.positionBefore=function(){return this._parent.position()},e.prototype.position=function(){return this._position},e.prototype.moveCounter=function(){return this._moveCounter},e.prototype.fullMoveNumber=function(){return Math.floor(this._moveCounter/2)+1},e.prototype.moveColor=function(){return this._moveCounter%2===0?"w":"b"},e.prototype.next=function(){return this._next},e.prototype.variations=function(){return this._variations.length},e.prototype.variation=function(t){return this._variations[t]},e.prototype.play=function(t){return this._next=new e(this,t),this._next.valid()},e.prototype.addVariation=function(t){var n=new i(this,this._withinLongVariation&&t);return this._variations.push(n),n},i.prototype=new n,i.prototype.constructor=i,i.prototype.isLongVariation=function(){return this._withinLongVariation},i.prototype.position=function(){return this._parent instanceof e?this._parent.positionBefore():this._parent.initialPosition()},i.prototype.moveCounter=function(){return this._parent instanceof e?this._parent.moveCounter():this._parent.initialMoveCounter()},i.prototype.first=function(){return this._first},i.prototype.play=function(t){return this._first=new e(this,t),this._first.valid()},o.prototype.headers=function(){var t=[];for(var n in this._headers)this._headers.hasOwnProperty(n)&&t.push(n);return t},o.prototype.header=function(t,n){var e=t in this._headers?this._headers[t]:null;return void 0!==n&&(this._headers[t]=n),e},o.prototype.initialPosition=function(){return this._initialPosition},o.prototype.initialMoveCounter=function(){return this._initialMoveCounter},o.prototype.defineInitialPosition=function(n){this._mainVariation=new i(this,!0);var e=new t(n);if(e.fen()!==n)return!1;if(!/^.* ([0-9]+)\s*$/.test(n))return!1;var o=parseInt(RegExp.$1,10);return this._initialPosition=n,this._initialMoveCounter=2*(o-1)+("w"===e.turn()?0:1),!0},o.prototype.mainVariation=function(){return this._mainVariation},o.prototype.result=function(t){var n=this._result;if(void 0!==t)switch(t){case"1-0":case"0-1":case"1/2-1/2":case"*":this._result=t}return n};var p={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+=":14,"+/=":14,"=":10,inf:13,"=+":15,"=/+":15,"-/+":17,"-+":19};return{Node:e,Variation:i,Item:o,Error:r,parse:s,parseOne:a}}(Chess);