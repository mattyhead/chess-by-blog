(function(e,t){"use strict";function nt(e){return Math.min(Math.max(e,et),tt)}function rt(e){return e===W||e===B?e:"none"}var n="options",r="_position",i="position",s=" uichess-chessboard-sprite",o='<div class="uichess-chessboard-cell"></div></div>',u="squareSize",a='<div class="uichess-chessboard-cell"></div>',f=" uichess-chessboard-color-",l='<div class="uichess-chessboard-cell">',c=".uichess-chessboard-table",h="_initialGeometryInfo",p='<div class="uichess-chessboard-sparePiece uichess-chessboard-piece-',d="element",v="allowMoves",m='<div class="uichess-chessboard-trash uichess-chessboard-sprite',g='<div class="uichess-chessboard-piece uichess-chessboard-piece-',y='"></div>',b=".uichess-chessboard-square",w="_trigger",E="change",S=null,x='<div class="uichess-chessboard-row">',T="showCoordinates",N="</div>",C="uichess-chessboard-inactiveFlag",k=".uichess-chessboard-turnFlag",L="square",A=".uichess-chessboard-sparePiece",O="8/8/8/8/8/8/8/8 w - - 0 1",M="draggable",_="empty",D=".uichess-chessboard-piece",P="uichess-chessboard-piece",H="uichess-chessboard",B="legal",j="sparePieces",F="_makePiecesDraggable",I="indexOf",q="_initializePosition",R="_fetchSquare",U="match",z="w",W="all",X="_refresh",V="abcdefgh",$="hgfedcba",J="flip",K="12345678",Q="87654321",G="move",Y="hasClass",Z="flags",et=20,tt=64;t.chessboard={MINIMUM_SQUARE_SIZE:et,MAXIMUM_SQUARE_SIZE:tt},t.widget("uichess.chessboard",{options:{position:O,flip:!1,squareSize:32,showCoordinates:!0,allowMoves:"none",sparePieces:!1},_position:S,_create:function(){this[d].addClass(H).disableSelection(),this[n][i]=this[q](this[n][i]),this[n][u]=nt(this[n][u]),this[n][v]=rt(this[n][v]),this[X]()},_destroy:function(){this[d][_]().removeClass(H).enableSelection()},_setOption:function(e,t){switch(e){case i:t=this[q](t);break;case u:t=nt(t);break;case v:t=rt(t)}this[n][e]=t,this[X](),e===i&&this[w](E,S,this[n][i])},_initializePosition:function(t){t=t.replace(/^\s+|\s+$/g,"");switch(t){case"start":t="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";break;case _:t=O}return this[r]=new e(t),t=this[r].fen(),t},turn:function(s){if(s===undefined)return this[r].turn();if(s!==z&&s!=="b")return;var o=this[n][i].split(/\s+/);if(o[1]===s)return;o[1]=s,o[3].length===2&&(o[3]=o[3].charAt(0)+(s===z?"6":"3"));var u=o.join(" ");t(k,this[d]).toggleClass(C),this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},castleRights:function(t){var s=this[n][i].split(/\s+/),o=s[2]==="-"?"":s[2];if(t===undefined)return o;if(t===o||!t[U](/^K?Q?k?q?$/))return;s[2]=t===""?"-":t;var u=s.join(" ");this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},enPassant:function(t){var s=this[n][i].split(/\s+/),o=s[3].length===2?s[3].charAt(0):"";if(t===undefined)return o;if(t===o||!o[U](/^[a-h]?$/))return;s[3]=t===""?"-":t+(s[1]===z?"6":"3");var u=s.join(" ");this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[h]===undefined&&(r[h]={squareSize:r[n][u],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[h].width,s=t.size.height-r[h].height,o=Math.floor(i/9),a=Math.floor(s/8),f=r[h][u]+Math.min(o,a);f=Math.min(Math.max(f,et),tt),f!==r[n][u]&&(r[n][u]=f,r[X]())})},_refresh:function(){var e=this[n][J]?K:Q,i=this[n][J]?$:V,c=this[n][u],h="pnbrqk 0",b='<div class="uichess-chessboard-table">';if(this[n][j]){b+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesTopRow">',this[n][T]&&(b+=a);var w=this[n][J]?z:"b";for(var E=0;E<8;++E)b+=l,h[E][U](/^[0-9]$/)?b+=m+c+y:h[E][U](/^[bknpqr]$/)&&(b+=p+h[E]+f+w+s+c+y),b+=N;b+=o}for(var C=0;C<8;++C){b+=x,this[n][T]&&(b+='<div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+e[C]+N);for(var E=0;E<8;++E){var k=i[E]+e[C],L=this[r].get(k);b+='<div class="uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-square'+c+" uichess-chessboard-"+this[r].square_color(k)+'Square">',L!==S&&(b+=g+L.type+f+L.color+s+c+y),b+=N}b+=l;if(e[C]==="8"||e[C]==="1"){var w=e[C]==="8"?"b":z,A=this[r].turn();b+='<div class="uichess-chessboard-turnFlag uichess-chessboard-color-'+w+s+c+(w===A?"":" uichess-chessboard-inactiveFlag")+y}b+="</div></div>"}if(this[n][T]){b+=x,b+=a;for(var E=0;E<8;++E)b+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+i[E]+N;b+=o}if(this[n][j]){b+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesBottomRow">',this[n][T]&&(b+=a);var w=this[n][J]?"b":z;for(var E=0;E<8;++E)b+=l,h[E][U](/^[0-9]$/)?b+=m+c+y:h[E][U](/^[bknpqr]$/)&&(b+=p+h[E]+f+w+s+c+y),b+=N;b+=o}b+=N,this[d][_](),t(b).appendTo(this[d]);var O=this[n][v]===W||this[n][v]===B,M=this[n][j];if(O||M)this._tagSquares(),this._makeSquareDroppable();O&&this[F](),M&&(this._tagSparePieces(),this._makeSparePiecesDraggable(),this._makeTrashDroppable())},_tagSquares:function(){var e=this[n][J]?K:Q,r=this[n][J]?$:V,i=0,s=0;t(b,this[d]).each(function(){t(this).data(L,r[s]+e[i]),++s,s===8&&(s=0,++i)})},_tagSparePieces:function(){var e="pnbrqk",r=this[n][J]?"wb":"bw",i=0,s=0;t(A,this[d]).each(function(){t(this).data("piece",{type:e[i],color:r[s]}),++i,i===6&&(i=0,++s)})},_fetchSquare:function(e){return t(b,this[d]).filter(function(){return t(this).data(L)===e})},_makeSquareDroppable:function(){var e=this,n=t(c,this[d]).get(0);t(b,this[d]).droppable({hoverClass:"uichess-chessboard-squareHover",accept:function(e){return t(e).closest(c).get(0)===n},drop:function(n,r){var i=t(n.target),s=r[M];if(s[Y]("uichess-chessboard-sparePiece")){var o=r[M].data("piece");e._doAddSparePiece(i.data(L),{type:o.type,color:o.color},i)}if(s[Y](P)){var u={from:s.parent().data(L),to:i.data(L)};u.from!==u.to&&e._doMove(u,s,i)}}})},_makeTrashDroppable:function(){var e=this,n=t(c,this[d]).get(0);t(".uichess-chessboard-trash",this[d]).droppable({hoverClass:"uichess-chessboard-trashHover",accept:function(e){return t(e)[Y](P)&&t(e).closest(c).get(0)===n},drop:function(n,r){e._doRemovePiece(r[M].parent().data(L),r[M],t(n.target))}})},_makePiecesDraggable:function(e){t(D,e===undefined?this[d]:e)[M]({cursor:G,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},revert:!0,revertDuration:0,zIndex:100})},_makeSparePiecesDraggable:function(e){t(A,e===undefined?this[d]:e)[M]({cursor:G,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},helper:"clone",revert:!0,revertDuration:0,zIndex:100})},_doMove:function(e,s,o){if(this[n][v]===W)this[r].put(this[r].remove(e.from),e.to),o[_]().append(s);else if(this[n][v]===B){var u=this[r][G](e);if(u===S){e.promotion="q",u=this[r][G](e);if(u===S)return}e=u,o[_]().append(s);if(e[Z][I]("k")>=0||e[Z][I]("q")>=0){var a=e.color===z?"1":"8",f=this[R]((e[Z][I]("k")>=0?"h":"a")+a),l=this[R]((e[Z][I]("k")>=0?"f":"d")+a);l[_]().append(t(D,f))}e[Z][I]("e")>=0&&this[R](e.to[0]+e.from[1])[_](),e[Z][I]("p")>=0&&s.removeClass("uichess-chessboard-piece-p").addClass("uichess-chessboard-piece-"+e.promotion),t(k,this[d]).toggleClass(C)}this[n][i]=this[r].fen(),this[w](G,S,e),this[w](E,S,this[n][i])},_doAddSparePiece:function(e,o,a){this[r].put(o,e),t(g+o.type+f+o.color+s+this[n][u]+y).appendTo(a[_]()),(this[n][v]===W||this[n][v]===B)&&this[F](a),this[n][i]=this[r].fen(),this[w]("add",S,{square:e,piece:o}),this[w](E,S,this[n][i])},_doRemovePiece:function(e,t,s){this[r].remove(e),s[_]().append(t),this[n][i]=this[r].fen(),this[w]("remove",S,e),this[w](E,S,this[n][i])}})})(Chess,jQuery);