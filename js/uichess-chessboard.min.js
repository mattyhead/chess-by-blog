(function(e,t){"use strict";function nt(e){return Math.min(Math.max(e,et),tt)}function rt(e){return e===U||e===H?e:"none"}var n="options",r="_position",i="position",s='<div class="uichess-chessboard-cell"></div></div>',o=" uichess-chessboard-size",u="squareSize",a='<div class="uichess-chessboard-cell"></div>',f=" uichess-chessboard-color-",l='<div class="uichess-chessboard-cell">',c=".uichess-chessboard-table",h="_initialGeometryInfo",p='<div class="uichess-chessboard-sparePiece uichess-chessboard-piece-',d="element",v="allowMoves",m='<div class="uichess-chessboard-piece uichess-chessboard-piece-',g='<div class="uichess-chessboard-trash uichess-chessboard-size',y='"></div>',b=".uichess-chessboard-square",w="_trigger",E="change",S=null,x="showCoordinates",T="</div>",N="uichess-chessboard-inactiveFlag",C=".uichess-chessboard-turnFlag",k=".uichess-chessboard-sparePiece",L="square",A="8/8/8/8/8/8/8/8 w - - 0 1",O="draggable",M="empty",_=".uichess-chessboard-piece",D="uichess-chessboard-piece",P="uichess-chessboard",H="legal",B="_makePiecesDraggable",j="indexOf",F="sparePieces",I="_initializePosition",q="_fetchSquare",R="match",U="all",z="w",W="data",X="12345678",V="flip",$="_refresh",J="hgfedcba",K="87654321",Q="abcdefgh",G="move",Y="flags",Z="hasClass",et=12,tt=64;t.chessboard={MINIMUM_SQUARE_SIZE:et,MAXIMUM_SQUARE_SIZE:tt},t.widget("uichess.chessboard",{options:{position:A,flip:!1,squareSize:32,showCoordinates:!0,allowMoves:"none",sparePieces:!1},_position:S,_create:function(){this[d].addClass(P).disableSelection(),this[n][i]=this[I](this[n][i]),this[n][u]=nt(this[n][u]),this[n][v]=rt(this[n][v]),this[$]()},_destroy:function(){this[d][M]().removeClass(P).enableSelection()},_setOption:function(e,t){switch(e){case i:t=this[I](t);break;case u:t=nt(t);break;case v:t=rt(t)}this[n][e]=t,this[$](),e===i&&this[w](E,S,this[n][i])},_initializePosition:function(t){t=t.replace(/^\s+|\s+$/g,"");switch(t){case"start":t="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";break;case M:t=A}return this[r]=new e(t),t=this[r].fen(),t},turn:function(s){if(s===undefined)return this[r].turn();if(s!==z&&s!=="b")return;var o=this[n][i].split(/\s+/);if(o[1]===s)return;o[1]=s,o[3].length===2&&(o[3]=o[3].charAt(0)+(s===z?"6":"3"));var u=o.join(" ");t(C,this[d]).toggleClass(N),this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},castleRights:function(t){var s=this[n][i].split(/\s+/),o=s[2]==="-"?"":s[2];if(t===undefined)return o;if(t===o||!t[R](/^K?Q?k?q?$/))return;s[2]=t===""?"-":t;var u=s.join(" ");this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},enPassant:function(t){var s=this[n][i].split(/\s+/),o=s[3].length===2?s[3].charAt(0):"";if(t===undefined)return o;if(t===o||!o[R](/^[a-h]?$/))return;s[3]=t===""?"-":t+(s[1]===z?"6":"3");var u=s.join(" ");this[r]=new e(u),this[n][i]=this[r].fen(),this[w](E,S,this[n][i])},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[h]===undefined&&(r[h]={squareSize:r[n][u],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[h].width,s=t.size.height-r[h].height,o=Math.floor(i/9),a=Math.floor(s/8),f=r[h][u]+Math.min(o,a);f=Math.min(Math.max(f,et),tt),f!==r[n][u]&&(r[n][u]=f,r[$]())})},_refresh:function(){var e=this[n][V]?X:K,i=this[n][V]?J:Q,c=this[n][u],h="pnbrqk 0",b='<div class="uichess-chessboard-table">';if(this[n][F]){b+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesTopRow">',this[n][x]&&(b+=a);var w=this[n][V]?z:"b";for(var E=0;E<8;++E)b+=l,h[E][R](/^[0-9]$/)?b+=g+c+y:h[E][R](/^[bknpqr]$/)&&(b+=p+h[E]+f+w+o+c+y),b+=T;b+=s}for(var N=0;N<8;++N){b+='<div class="uichess-chessboard-row">',this[n][x]&&(b+='<div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+e[N]+T);for(var E=0;E<8;++E){var C=i[E]+e[N],k=this[r].get(C);b+='<div class="uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-size'+c+" uichess-chessboard-"+this[r].square_color(C)+'Square">',k!==S&&(b+=m+k.type+f+k.color+o+c+y),b+=T}b+=l;if(e[N]==="8"||e[N]==="1"){var w=e[N]==="8"?"b":z,L=this[r].turn();b+='<div class="uichess-chessboard-turnFlag uichess-chessboard-color-'+w+o+c+(w===L?"":" uichess-chessboard-inactiveFlag")+y}b+="</div></div>"}if(this[n][x]){b+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow">',b+=a;for(var E=0;E<8;++E)b+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+i[E]+T;b+=s}if(this[n][F]){b+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesBottomRow">',this[n][x]&&(b+=a);var w=this[n][V]?"b":z;for(var E=0;E<8;++E)b+=l,h[E][R](/^[0-9]$/)?b+=g+c+y:h[E][R](/^[bknpqr]$/)&&(b+=p+h[E]+f+w+o+c+y),b+=T;b+=s}b+=T,this[d][M](),t(b).appendTo(this[d]);var A=this[n][v]===U||this[n][v]===H,O=this[n][F];if(A||O)this._tagSquares(),this._makeSquareDroppable();A&&this[B](),O&&(this._tagSparePieces(),this._makeSparePiecesDraggable(),this._makeTrashDroppable())},_tagSquares:function(){var e=this[n][V]?X:K,r=this[n][V]?J:Q,i=0,s=0;t(b,this[d]).each(function(){t(this)[W](L,r[s]+e[i]),++s,s===8&&(s=0,++i)})},_tagSparePieces:function(){var e="pnbrqk",r=this[n][V]?"wb":"bw",i=0,s=0;t(k,this[d]).each(function(){t(this)[W]("piece",{type:e[i],color:r[s]}),++i,i===6&&(i=0,++s)})},_fetchSquare:function(e){return t(b,this[d]).filter(function(){return t(this)[W](L)===e})},_makeSquareDroppable:function(){var e=this,n=t(c,this[d]).get(0);t(b,this[d]).droppable({hoverClass:"uichess-chessboard-squareHover",accept:function(e){return t(e).closest(c).get(0)===n},drop:function(n,r){var i=t(n.target),s=r[O];if(s[Z]("uichess-chessboard-sparePiece")){var o=r[O][W]("piece");e._doAddSparePiece(i[W](L),{type:o.type,color:o.color},i)}if(s[Z](D)){var u={from:s.parent()[W](L),to:i[W](L)};u.from!==u.to&&e._doMove(u,s,i)}}})},_makeTrashDroppable:function(){var e=this,n=t(c,this[d]).get(0);t(".uichess-chessboard-trash",this[d]).droppable({hoverClass:"uichess-chessboard-trashHover",accept:function(e){return t(e)[Z](D)&&t(e).closest(c).get(0)===n},drop:function(n,r){e._doRemovePiece(r[O].parent()[W](L),r[O],t(n.target))}})},_makePiecesDraggable:function(e){t(_,e===undefined?this[d]:e)[O]({cursor:G,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},revert:!0,revertDuration:0,zIndex:100})},_makeSparePiecesDraggable:function(e){t(k,e===undefined?this[d]:e)[O]({cursor:G,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},helper:"clone",revert:!0,revertDuration:0,zIndex:100})},_doMove:function(e,s,o){if(this[n][v]===U)this[r].put(this[r].remove(e.from),e.to),o[M]().append(s);else if(this[n][v]===H){var u=this[r][G](e);if(u===S){e.promotion="q",u=this[r][G](e);if(u===S)return}e=u,o[M]().append(s);if(e[Y][j]("k")>=0||e[Y][j]("q")>=0){var a=e.color===z?"1":"8",f=this[q]((e[Y][j]("k")>=0?"h":"a")+a),l=this[q]((e[Y][j]("k")>=0?"f":"d")+a);l[M]().append(t(_,f))}e[Y][j]("e")>=0&&this[q](e.to[0]+e.from[1])[M](),e[Y][j]("p")>=0&&s.removeClass("uichess-chessboard-piece-p").addClass("uichess-chessboard-piece-"+e.promotion),t(C,this[d]).toggleClass(N)}this[n][i]=this[r].fen(),this[w](G,S,e),this[w](E,S,this[n][i])},_doAddSparePiece:function(e,s,a){this[r].put(s,e),t(m+s.type+f+s.color+o+this[n][u]+y).appendTo(a[M]()),(this[n][v]===U||this[n][v]===H)&&this[B](a),this[n][i]=this[r].fen(),this[w]("add",S,{square:e,piece:s}),this[w](E,S,this[n][i])},_doRemovePiece:function(e,t,s){this[r].remove(e),s[M]().append(t),this[n][i]=this[r].fen(),this[w]("remove",S,e),this[w](E,S,this[n][i])}})})(Chess,jQuery);