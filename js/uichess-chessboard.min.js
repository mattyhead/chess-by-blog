(function(e,t){"use strict";function yt(e,t){var n={},r=e.split(",");for(var i=0;i<r.length;++i)t[K](r[i])&&(n[RegExp.$2]=RegExp.$1);return n}function bt(e){var t=[];for(var n in e)e[it](n)&&t.push(e[n]+n);return t.join(",")}function wt(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?et:e==="false"||e==="0"||e==="off"?$:t):t}function Et(e){return Math.min(Math.max(e,ct),ht)}function St(e){return e===tt||e===rt||/^addPieces-[wb][kqrbnp]$/[K](e)||/^add(?:Square|Arrow)Markers-[GRY]$/[K](e)?e:"none"}function xt(t,n){n=n.replace(/^\s+|\s+$/g,"");try{t[r]=new e.Position(n),n=t[r].fen()}catch(i){if(!(i instanceof e.exceptions.InvalidFEN))throw t[r]=S,i;t[r]=i}return n}function Tt(e,t){return e[s]=yt(t,dt),bt(e[s])}function Nt(e,t){return e[i]=yt(t,vt),bt(e[i])}function Ct(e){e[f][z]()}function kt(e){var t='<div class="uichess-chessboard-error"><div class="uichess-chessboard-errorTitle">Error while analysing a FEN string.</div>';return e[r].message!==S&&(t+='<div class="uichess-chessboard-errorMessage">'+e[r].message+x),t+=x,t}function Lt(t){var o=t[n][j]?D:P,u=t[n][j]?H:I,f="uichess-chessboard-table uichess-chessboard-size"+t[n][h];t[n][E]||(f+=" uichess-chessboard-hideCoordinates");var l=q+f+'">';for(var c=0;c<8;++c){l+='<div class="uichess-chessboard-row"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+o[c]+x;for(var d=0;d<8;++d){var m=u[d]+o[c],b=e.squareColor(m)==="w"?"light":"dark",w="uichess-chessboard-sized uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-"+b+"Square";m in t[s]&&(w+=" uichess-chessboard-squareMarker uichess-chessboard-markerColor-"+t[s][m]),l+=q+w+'">';var S=t[r][g](m);S==="-"?l+=pt:l+=p+S.piece+B+S.color+'">'+pt+x,l+=x}l+='<div class="uichess-chessboard-cell">';if(o[c]==="8"||o[c]==="1"){var T=o[c]==="8"?"b":"w",w="uichess-chessboard-sized uichess-chessboard-turnFlag uichess-chessboard-color-"+T;T!==t[r].turn()&&(w+=" uichess-chessboard-inactiveFlag"),l+=q+w+'"></div>'}l+="</div></div>"}l+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate"></div>';for(var d=0;d<8;++d)l+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+u[d]+x;l+='<div class="uichess-chessboard-cell"></div></div>',l+='<svg class="uichess-chessboard-annotations" viewBox="0 0 8 8"><defs><marker id="uichess-chessboard-arrowMarkerEnd-G" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-R" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-Y" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker></defs>';for(var N in t[i])if(t[i][it](N)&&/^([a-h][1-8])([a-h][1-8])$/[K](N)){var C=RegExp.$1,k=RegExp.$2;if(C!==k){var L=jt(t,C,k),w=a+C+k+y+t[i][N],A=v+t[i][N]+")";l+='<line class="'+w+'" x1="'+L.x1+'" y1="'+L.y1+'" x2="'+L.x2+'" y2="'+L.y2+'" marker-end="'+A+'" />'}}return l+="</svg>",l+=x,l}function At(i){Ct(i);if(i[r]===S)return;if(i[r]instanceof e.exceptions.InvalidFEN)t(kt(i))[st](i[f]);else{t(Lt(i))[st](i[f]);if(i[n][l]===tt||i[n][l]===rt)Ft(i),It(i,i[n][l]===tt);else if(/^addPieces-([wb])([kqrbnp])$/[K](i[n][l])){var s=RegExp.$1,o=RegExp.$2;Ft(i),qt(i,{color:s,piece:o})}else if(/^addSquareMarkers-([GRY])$/[K](i[n][l])){var u=RegExp.$1;Ft(i),Rt(i,u)}else if(/^addArrowMarkers-([GRY])$/[K](i[n][l])){var u=RegExp.$1;Ft(i),Ut(i,u)}}}function Ot(e){t(M,e[f])[Y](k)}function Mt(e,n,r){t(u,e[f])[T](W+n)[F](W+r)}function _t(e){t(u,e[f])[Y]("uichess-chessboard-hideCoordinates")}function Dt(e,t,n){typeof t===d?e[F](L)[F](c+n):typeof n===d?e[T](L)[T](c+t):e[T](c+t)[F](c+n)}function Pt(e,n,r,i){if(typeof r===d){var s=n.substr(0,2),o=n.substr(2,2);if(s!==o){var u=jt(e,s,o),l=a+n+y+i,c=v+i+")",h=t(document[ot](U,"line"));h.attr({x1:u.x1,y1:u.y1,x2:u.x2,y2:u.y2,"class":l,"marker-end":c}),t(O,e[f])[V](h)}}else if(typeof i===d)t(A+n,e[f]).remove();else{var l=a+n+y+i;t(A+n,e[f]).attr("class",l)}}function Ht(e,r){var i=e[n][j]?D:P,s=e[n][j]?H:I,u=i[ut](r[1]),a=s[ut](r[0]);return t(t(o,e[f]).get(u*8+a))}function Bt(e,t){var r=e[n][j]?D:P,i=e[n][j]?H:I;return{x:i[ut](t[0])+.5,y:r[ut](t[1])+.5}}function jt(e,t,n){var r=Bt(e,t),i=Bt(e,n);return i.x+=r.x<i.x?-0.3:r.x>i.x?.3:0,i.y+=r.y<i.y?-0.3:r.y>i.y?.3:0,{x1:r.x,y1:r.y,x2:i.x,y2:i.y}}function Ft(e){var r=e[n][j]?D:P,i=e[n][j]?H:I,s=0,u=0;t(o,e[f]).each(function(e,n){t(n).data(g,i[u]+r[s]),++u,u===8&&(u=0,++s)})}function It(e,r){t(X,e[f])[at]({cursor:"move",cursorAt:{top:e[n][h]/2,left:e[n][h]/2},revert:et,revertDuration:0,zIndex:300});var i=t(u,e[f]).get(0),s=r?Wt:zt;t(o,e[f]).droppable({hoverClass:_,accept:function(e){return t(e).closest(u).get(0)===i},drop:function(n,r){var i=t(n.target),o=r[at];if(o.hasClass("uichess-chessboard-piece")){var u={from:o.parent().data(g),to:i.data(g)};u.from!==u.to&&s(e,u,o,i)}}})}function qt(e,n){t(o,e[f]).mousedown(function(){Xt(e,n,t(this).data(g),t(this))})}function Rt(e,n){t(o,e[f]).mousedown(function(){Vt(e,n,t(this).data(g),t(this))})}function Ut(e,r){function p(e){return(e-s.left)*8/l}function d(e){return(e-s.top)*8/c}var i=S,s=S,a=t(O,e[f]),l=a.width(),c=a.height();t(".uichess-chessboard-square .uichess-chessboard-handle",e[f])[at]({cursor:"crosshair",cursorAt:{top:e[n][h]/2,left:e[n][h]/2},helper:function(){return t('<div class="uichess-chessboard-sized"></div>')},start:function(n){i=t(n.target).closest(o).data(g),s=a.offset();var u="uichess-chessboard-arrowMarker uichess-chessboard-markerColor-"+r,f=v+r+")",l=Bt(e,i),c=t(document[ot](U,"line"));c.attr({x1:l.x,y1:l.y,x2:l.x,y2:l.y,"class":u,"marker-end":f,id:"uichess-chessboard-draggedArrowMarker"}),c[st](a)},drag:function(e){t(N).attr({x2:p(e.pageX),y2:d(e.pageY)})},stop:function(){t(N).remove()}});var m=t(u,e[f]).get(0);t(o,e[f]).droppable({hoverClass:_,accept:function(e){return t(e).closest(u).get(0)===m},drop:function(n){var s=t(n.target).data(g);$t(e,r,i,s)}})}function zt(e,t,n,i){e[r][g](t.to,e[r][g](t.from)),e[r][g](t.from,"-"),n.parent()[V](pt),i[z]()[V](n),Jt(e)}function Wt(n,i,s,o){var u=n[r].isMoveLegal(i);if(u===$){i.promotion="q",u=n[r].isMoveLegal(i);if(u===$)return}n[r][tt](u),s.parent()[V](pt),o[z]()[V](s);if(u.type()===e[lt].CASTLING_MOVE){var a=Ht(n,u.rookFrom()),l=Ht(n,u.rookTo());a[V](pt),l[z]()[V](t(X,a))}u.type()===e[lt].EN_PASSANT_CAPTURE&&Ht(n,u.enPassantSquare())[z]()[V](pt),u.type()===e[lt].PROMOTION&&s[T]("uichess-chessboard-piece-p")[F]("uichess-chessboard-piece-"+u.promotion()),t(M,n[f])[Y](k),Jt(n)}function Xt(e,t,n,i){var s=e[r][g](n);typeof s=="object"&&s.color===t.color&&s.piece===t.piece?(e[r][g](n,"-"),i[z]()[V](pt)):(e[r][g](n,t),i[z]()[V](p+t.piece+B+t.color+'">'+pt+x)),Jt(e)}function Vt(e,t,n,r){e[s][n]===t?(Dt(r,t),delete e[s][n]):(Dt(r,e[s][n],t),e[s][n]=t),Kt(e)}function $t(e,t,n,r){var s=n+r;e[i][s]===t?(Pt(e,s,e[i][s]),delete e[i][s]):(Pt(e,s,e[i][s],t),e[i][s]=t),Qt(e)}function Jt(e){var t=e[n][C];e[n][C]=e[r].fen(),e[R](nt,S,{oldValue:t,newValue:e[n][C]})}function Kt(e){var t=e[n][m];e[n][m]=bt(e[s]),e[R](J,S,{oldValue:t,newValue:e[n][m]})}function Qt(e){var t=e[n][b];e[n][b]=bt(e[i]),e[R](Q,S,{oldValue:t,newValue:e[n][b]})}var n="options",r="_position",i="_arrowMarkers",s="_squareMarkers",o=".uichess-chessboard-square",u=".uichess-chessboard-table",a="uichess-chessboard-arrowMarker uichess-chessboard-arrowMarker-",f="element",l="interactionMode",c="uichess-chessboard-markerColor-",h="squareSize",p='<div class="uichess-chessboard-sized uichess-chessboard-piece uichess-chessboard-piece-',d="undefined",v="url(#uichess-chessboard-arrowMarkerEnd-",m="squareMarkers",g="square",y=" uichess-chessboard-markerColor-",b="arrowMarkers",w="_initialGeometryInfo",E="showCoordinates",S=null,x="</div>",T="removeClass",N="#uichess-chessboard-draggedArrowMarker",C="position",k="uichess-chessboard-inactiveFlag",L="uichess-chessboard-squareMarker",A=".uichess-chessboard-arrowMarker-",O=".uichess-chessboard-annotations",M=".uichess-chessboard-turnFlag",_="uichess-chessboard-squareHover",D="12345678",P="87654321",H="hgfedcba",B=" uichess-chessboard-color-",j="flip",F="addClass",I="abcdefgh",q='<div class="',R="_trigger",U="http://www.w3.org/2000/svg",z="empty",W="uichess-chessboard-size",X=".uichess-chessboard-piece",V="append",$=!1,J="squareMarkersChange",K="test",Q="arrowMarkersChange",G="uichess-chessboard",Y="toggleClass",Z="castleRights",et=!0,tt="play",nt="positionChange",rt="movePieces",it="hasOwnProperty",st="appendTo",ot="createElementNS",ut="indexOf",at="draggable",ft="enPassant",lt="movetype",ct=12,ht=64,pt='<div class="uichess-chessboard-handle"></div>',dt=/^\s*([GRY])([a-h][1-8])\s*$/,vt=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,mt=/^\s*[GRY]?([a-h][1-8])\s*$/,gt=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;t.chessboard={MINIMUM_SQUARE_SIZE:ct,MAXIMUM_SQUARE_SIZE:ht},t.widget("uichess.chessboard",{options:{position:z,squareMarkers:"",arrowMarkers:"",flip:$,squareSize:32,showCoordinates:et,interactionMode:"none"},_position:S,_squareMarkers:S,_arrowMarkers:S,_create:function(){this[f][F](G).disableSelection(),this[n][C]=xt(this,this[n][C]),this[n][m]=Tt(this,this[n][m]),this[n][b]=Nt(this,this[n][b]),this[n][h]=Et(this[n][h]),this[n][l]=St(this[n][l]),this[n][j]=wt(this[n][j],$),this[n][E]=wt(this[n][E],et),At(this)},_destroy:function(){this[f][z]()[T](G).enableSelection()},_setOption:function(e,t){switch(e){case C:t=xt(this,t);break;case m:t=Tt(this,t);break;case b:t=Nt(this,t);break;case h:t=Et(t);break;case l:t=St(t);break;case j:t=wt(t,$);break;case E:t=wt(t,et)}var r=this[n][e];if(r===t)return;this[n][e]=t;switch(e){case C:At(this),this[R](nt,S,{oldValue:r,newValue:this[n][C]});break;case m:At(this),this[R](J,S,{oldValue:r,newValue:this[n][m]});break;case b:At(this),this[R](Q,S,{oldValue:r,newValue:this[n][b]});break;case j:At(this),this[R]("flipChange",S,{oldValue:r,newValue:this[n][j]});break;case h:Mt(this,r,t);break;case E:_t(this);break;default:At(this)}},turn:function(e){if(typeof e===d||e===S)return this[r].turn();e!==this[r].turn()&&(this[r].turn(e),Ot(this),Jt(this))},castleRights:function(e,t,n){if(typeof n===d||n===S)return this[r][Z](e,t);n!==this[r][Z](e,t)&&(this[r][Z](e,t,n),Jt(this))},enPassant:function(e){if(typeof e===d||e===S)return this[r][ft]();e!==this[r][ft]()&&(this[r][ft](e),Jt(this))},addSquareMarker:function(e){if(dt[K](e)){var t=RegExp.$1,n=RegExp.$2;this[s][n]!==t&&(Dt(Ht(this,n),this[s][n],t),this[s][n]=t,Kt(this))}},removeSquareMarker:function(e){if(mt[K](e)){var t=RegExp.$1;typeof this[s][t]!==d&&(Dt(Ht(this,t),this[s][t]),delete this[s][t],Kt(this))}},addArrowMarker:function(e){if(vt[K](e)){var t=RegExp.$1,n=RegExp.$2;this[i][n]!==t&&(Pt(this,n,this[i][n],t),this[i][n]=t,Qt(this))}},removeArrowMarker:function(e){if(gt[K](e)){var t=RegExp.$1;typeof this[i][t]!==d&&(Pt(this,t,this[i][t]),delete this[i][t],Qt(this))}},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[w]===undefined&&(r[w]={squareSize:r[n][h],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[w].width,s=t.size.height-r[w].height,o=Math.floor(i/9),u=Math.floor(s/8),a=r[w][h]+Math.min(o,u);r._setOption(h,a)})}})})(RPBChess,jQuery);