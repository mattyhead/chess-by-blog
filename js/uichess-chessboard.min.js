!function(s,i){"use strict";function e(s){return Math.min(Math.max(s,t),a)}function o(s){return"all"===s||"legal"===s?s:"none"}var t=20,a=64;i.chessboard={MINIMUM_SQUARE_SIZE:t,MAXIMUM_SQUARE_SIZE:a},i.widget("uichess.chessboard",{options:{position:"8/8/8/8/8/8/8/8 w - - 0 1",flip:!1,squareSize:32,showCoordinates:!0,allowMoves:"none",sparePieces:!1},_position:null,_create:function(){this.element.addClass("uichess-chessboard").disableSelection(),this.options.position=this._initializePosition(this.options.position),this.options.squareSize=e(this.options.squareSize),this.options.allowMoves=o(this.options.allowMoves),this._refresh()},_destroy:function(){this.element.empty().removeClass("uichess-chessboard").enableSelection()},_setOption:function(s,i){switch(s){case"position":i=this._initializePosition(i);break;case"squareSize":i=e(i);break;case"allowMoves":i=o(i)}this.options[s]=i,this._refresh(),"position"===s&&this._trigger("change",null,this.options.position)},_initializePosition:function(i){switch(i=i.replace(/^\s+|\s+$/g,"")){case"start":i="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";break;case"empty":i="8/8/8/8/8/8/8/8 w - - 0 1"}return this._position=new s(i),i=this._position.fen()},turn:function(e){if(void 0===e)return this._position.turn();if("w"===e||"b"===e){var o=this.options.position.split(/\s+/);if(o[1]!==e){o[1]=e,2===o[3].length&&(o[3]=o[3].charAt(0)+("w"===e?"6":"3"));var t=o.join(" ");i(".uichess-chessboard-turnFlag",this.element).toggleClass("uichess-chessboard-inactiveFlag"),this._position=new s(t),this.options.position=this._position.fen(),this._trigger("change",null,this.options.position)}}},castleRights:function(i){var e=this.options.position.split(/\s+/),o="-"===e[2]?"":e[2];if(void 0===i)return o;if(i!==o&&i.match(/^K?Q?k?q?$/)){e[2]=""===i?"-":i;var t=e.join(" ");this._position=new s(t),this.options.position=this._position.fen(),this._trigger("change",null,this.options.position)}},enPassant:function(i){var e=this.options.position.split(/\s+/),o=2===e[3].length?e[3].charAt(0):"";if(void 0===i)return o;if(i!==o&&o.match(/^[a-h]?$/)){e[3]=""===i?"-":i+("w"===e[1]?"6":"3");var t=e.join(" ");this._position=new s(t),this.options.position=this._position.fen(),this._trigger("change",null,this.options.position)}},sizeControlledByContainer:function(s,i){var e=this;s.on(i,function(s,i){void 0===e._initialGeometryInfo&&(e._initialGeometryInfo={squareSize:e.options.squareSize,height:i.originalSize.height,width:i.originalSize.width});var o=i.size.width-e._initialGeometryInfo.width,r=i.size.height-e._initialGeometryInfo.height,n=Math.floor(o/9),h=Math.floor(r/8),c=e._initialGeometryInfo.squareSize+Math.min(n,h);c=Math.min(Math.max(c,t),a),c!==e.options.squareSize&&(e.options.squareSize=c,e._refresh())})},_refresh:function(){var s={light:"#f0dec7",dark:"#b5876b"},e=this.options.flip?["1","2","3","4","5","6","7","8"]:["8","7","6","5","4","3","2","1"],o=this.options.flip?["h","g","f","e","d","c","b","a"]:["a","b","c","d","e","f","g","h"],t=this.options.squareSize,a={b:0,k:t,n:2*t,p:3*t,q:4*t,r:5*t,x:6*t},r={b:0,w:t,x:2*t},n=["p","n","b","r","q","k","","0"],h='<div class="uichess-chessboard-table">';if(this.options.sparePieces){h+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesTopRow">',this.options.showCoordinates&&(h+='<div class="uichess-chessboard-cell"></div>');for(var c=this.options.flip?"w":"b",p=0;8>p;++p)h+='<div class="uichess-chessboard-cell">',n[p].match(/^[0-9]$/)?h+='<div class="uichess-chessboard-trash uichess-chessboard-sprite'+t+'" style="background-position: -'+n[p]*t+"px -"+r.x+'px;"></div>':n[p].match(/^[bknpqr]$/)&&(h+='<div class="uichess-chessboard-sparePiece uichess-chessboard-sprite'+t+'" style="background-position: -'+a[n[p]]+"px -"+r[c]+'px;"></div>'),h+="</div>";h+='<div class="uichess-chessboard-cell"></div></div>'}for(var l=0;8>l;++l){h+='<div class="uichess-chessboard-row">',this.options.showCoordinates&&(h+='<div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+e[l]+"</div>");for(var p=0;8>p;++p){var d=o[p]+e[l],u=this._position.get(d);h+='<div class="uichess-chessboard-cell uichess-chessboard-square" style="width: '+t+"px; height: "+t+"px; background-color: "+s[this._position.square_color(d)]+';">',null!==u&&(h+='<div class="uichess-chessboard-piece uichess-chessboard-sprite'+t+'" style="background-position: -'+a[u.type]+"px -"+r[u.color]+'px;"></div>'),h+="</div>"}if(h+='<div class="uichess-chessboard-cell">',"8"===e[l]||"1"===e[l]){var b="background-position: -"+a.x+"px -"+r["8"===e[l]?"b":"w"]+"px;",v="uichess-chessboard-turnFlag uichess-chessboard-sprite"+t,f=this._position.turn();("8"===e[l]&&"w"===f||"1"===e[l]&&"b"===f)&&(v+=" uichess-chessboard-inactiveFlag"),h+='<div class="'+v+'" style="'+b+'"></div>'}h+="</div></div>"}if(this.options.showCoordinates){h+='<div class="uichess-chessboard-row">',h+='<div class="uichess-chessboard-cell"></div>';for(var p=0;8>p;++p)h+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+o[p]+"</div>";h+='<div class="uichess-chessboard-cell"></div></div>'}if(this.options.sparePieces){h+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesBottomRow">',this.options.showCoordinates&&(h+='<div class="uichess-chessboard-cell"></div>');for(var c=this.options.flip?"b":"w",p=0;8>p;++p)h+='<div class="uichess-chessboard-cell">',n[p].match(/^[0-9]$/)?h+='<div class="uichess-chessboard-trash uichess-chessboard-sprite'+t+'" style="background-position: -'+n[p]*t+"px -"+r.x+'px;"></div>':n[p].match(/^[bknpqr]$/)&&(h+='<div class="uichess-chessboard-sparePiece uichess-chessboard-sprite'+t+'" style="background-position: -'+a[n[p]]+"px -"+r[c]+'px;"></div>'),h+="</div>";h+='<div class="uichess-chessboard-cell"></div></div>'}h+="</div>",this.element.empty(),i(h).appendTo(this.element);var g="all"===this.options.allowMoves||"legal"===this.options.allowMoves,_=this.options.sparePieces;(g||_)&&(this._tagSquares(),this._makeSquareDroppable()),g&&this._makePiecesDraggable(),_&&(this._tagSparePieces(),this._makeSparePiecesDraggable(),this._makeTrashDroppable())},_tagSquares:function(){var s=this.options.flip?["1","2","3","4","5","6","7","8"]:["8","7","6","5","4","3","2","1"],e=this.options.flip?["h","g","f","e","d","c","b","a"]:["a","b","c","d","e","f","g","h"],o=0,t=0;i(".uichess-chessboard-square",this.element).each(function(){i(this).data("square",e[t]+s[o]),++t,8===t&&(t=0,++o)})},_tagSparePieces:function(){var s=["p","n","b","r","q","k"],e=this.options.flip?["w","b"]:["b","w"],o=0,t=0;i(".uichess-chessboard-sparePiece",this.element).each(function(){i(this).data("piece",{type:s[o],color:e[t]}),++o,6===o&&(o=0,++t)})},_fetchSquare:function(s){return i(".uichess-chessboard-square",this.element).filter(function(){return i(this).data("square")===s})},_makeSquareDroppable:function(){var s=this,e=i(".uichess-chessboard-table",this.element).get(0);i(".uichess-chessboard-square",this.element).droppable({hoverClass:"uichess-chessboard-squareHover",accept:function(s){return i(s).closest(".uichess-chessboard-table").get(0)===e},drop:function(e,o){var t=i(e.target),a=o.draggable;if(a.hasClass("uichess-chessboard-sparePiece")){var r=o.draggable.data("piece");s._doAddSparePiece(t.data("square"),{type:r.type,color:r.color},t)}if(a.hasClass("uichess-chessboard-piece")){var n={from:a.parent().data("square"),to:t.data("square")};n.from!==n.to&&s._doMove(n,a,t)}}})},_makeTrashDroppable:function(){var s=this,e=i(".uichess-chessboard-table",this.element).get(0);i(".uichess-chessboard-trash",this.element).droppable({hoverClass:"uichess-chessboard-trashHover",accept:function(s){return i(s).hasClass("uichess-chessboard-piece")&&i(s).closest(".uichess-chessboard-table").get(0)===e},drop:function(e,o){s._doRemovePiece(o.draggable.parent().data("square"),o.draggable,i(e.target))}})},_makePiecesDraggable:function(s){var e=this.options.squareSize;i(".uichess-chessboard-piece",void 0===s?this.element:s).draggable({cursor:"move",cursorAt:{top:e/2,left:e/2},revert:!0,revertDuration:0,zIndex:100})},_makeSparePiecesDraggable:function(s){var e=this.options.squareSize;i(".uichess-chessboard-sparePiece",void 0===s?this.element:s).draggable({cursor:"move",cursorAt:{top:e/2,left:e/2},helper:"clone",revert:!0,revertDuration:0,zIndex:100})},_doMove:function(s,e,o){if("all"===this.options.allowMoves)this._position.put(this._position.remove(s.from),s.to),o.empty().append(e);else if("legal"===this.options.allowMoves){var t=this._position.move(s);if(null===t&&(s.promotion="q",t=this._position.move(s),null===t))return;if(s=t,o.empty().append(e),s.flags.indexOf("k")>=0||s.flags.indexOf("q")>=0){var a="w"===s.color?"1":"8",r=this._fetchSquare((s.flags.indexOf("k")>=0?"h":"a")+a),n=this._fetchSquare((s.flags.indexOf("k")>=0?"f":"d")+a);n.empty().append(i(".uichess-chessboard-piece",r))}if(s.flags.indexOf("e")>=0&&this._fetchSquare(s.to[0]+s.from[1]).empty(),s.flags.indexOf("p")>=0){var h=this.options.squareSize,c={b:0,k:h,n:2*h,p:3*h,q:4*h,r:5*h,x:6*h},p={b:0,w:h};e.css("background-position","-"+c[s.promotion]+"px -"+p[s.color]+"px")}i(".uichess-chessboard-turnFlag",this.element).toggleClass("uichess-chessboard-inactiveFlag")}this.options.position=this._position.fen(),this._trigger("move",null,s),this._trigger("change",null,this.options.position)},_doAddSparePiece:function(s,e,o){this._position.put(e,s);var t=this.options.squareSize,a={b:0,k:t,n:2*t,p:3*t,q:4*t,r:5*t,x:6*t},r={b:0,w:t};i('<div class="uichess-chessboard-piece uichess-chessboard-sprite'+t+'" style="background-position: -'+a[e.type]+"px -"+r[e.color]+'px;"></div>').appendTo(o.empty()),("all"===this.options.allowMoves||"legal"===this.options.allowMoves)&&this._makePiecesDraggable(o),this.options.position=this._position.fen(),this._trigger("add",null,{square:s,piece:e}),this._trigger("change",null,this.options.position)},_doRemovePiece:function(s,i,e){this._position.remove(s),e.empty().append(i),this.options.position=this._position.fen(),this._trigger("remove",null,s),this._trigger("change",null,this.options.position)}})}(Chess,jQuery);