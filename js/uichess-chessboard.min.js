(function(e,t){"use strict";function wt(e,t){var n={},r=e.split(",");for(var i=0;i<r.length;++i)t[G](r[i])&&(n[RegExp.$2]=RegExp.$1);return n}function Et(e){var t=[];for(var n in e)e[A](n)&&t.push(e[n]+n);return t.join(",")}function St(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?nt:e==="false"||e==="0"||e==="off"?M:t):t}function xt(e){return Math.min(Math.max(e,pt),dt)}function Tt(e){return e===rt||e===st||/^addPieces-[wb][kqrbnp]$/[G](e)||/^add(?:Square|Arrow)Markers-[GRY]$/[G](e)?e:"none"}function Nt(e){return Math.max(0,e)}function Ct(t,n){n=n.replace(/^\s+|\s+$/g,"");try{t[s]=new e.Position(n),n=t[s].fen()}catch(r){if(!(r instanceof e.exceptions.InvalidFEN))throw t[s]=T,r;t[s]=r}return n}function kt(e,t){return e[i]=wt(t,mt),Et(e[i])}function Lt(e,t){return e[r]=wt(t,gt),Et(e[r])}function At(e){e[u][K]()}function Ot(e){var t='<div class="uichess-chessboard-error"><div class="uichess-chessboard-errorTitle">Error while analysing a FEN string.</div>';return e[s].message!==T&&(t+='<div class="uichess-chessboard-errorMessage">'+e[s].message+N),t+=N,t}function Mt(t){var o=t[n][D]?W:I,u=t[n][D]?q:z,a="uichess-chessboard-table uichess-chessboard-size"+t[n][l];t[n][x]||(a+=" uichess-chessboard-hideCoordinates");var f=X+a+'">';for(var c=0;c<8;++c){f+='<div class="uichess-chessboard-row"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+o[c]+N;for(var h=0;h<8;++h){var d=u[h]+o[c],v=e.squareColor(d)==="w"?"light":"dark",m="uichess-chessboard-sized uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-"+v+"Square";d in t[i]&&(m+=" uichess-chessboard-squareMarker uichess-chessboard-markerColor-"+t[i][d]),f+=X+m+'">';var y=t[s][g](d);y==="-"?f+=vt:f+=p+y.piece+U+y.color+'">'+vt+N,f+=N}f+='<div class="uichess-chessboard-cell">';if(o[c]==="8"||o[c]==="1"){var w=o[c]==="8"?"b":"w",m="uichess-chessboard-sized uichess-chessboard-turnFlag uichess-chessboard-color-"+w;w!==t[s].turn()&&(m+=" uichess-chessboard-inactiveFlag"),f+=X+m+'"></div>'}f+="</div></div>"}f+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate"></div>';for(var h=0;h<8;++h)f+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+u[h]+N;f+='<div class="uichess-chessboard-cell"></div></div>',f+='<svg class="uichess-chessboard-annotations" viewBox="0 0 8 8"><defs><marker id="uichess-chessboard-arrowMarkerEnd-G" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-R" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-Y" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-B" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker></defs>';for(var E in t[r])if(t[r][A](E)&&/^([a-h][1-8])([a-h][1-8])$/[G](E)){var S=RegExp.$1,T=RegExp.$2;if(S!==T){var k=zt(t,S,T),m="uichess-chessboard-arrowMarker uichess-chessboard-arrowMarker-"+S+T+b+t[r][E],L=C+t[r][E]+")";f+='<line class="'+m+'" x1="'+k.x1+'" y1="'+k.y1+'" x2="'+k.x2+'" y2="'+k.y2+'" marker-end="'+L+'" />'}}return f+="</svg>",f+=N,f}function _t(r){At(r);if(r[s]===T)return;if(r[s]instanceof e.exceptions.InvalidFEN)t(Ot(r)).appendTo(r[u]);else{t(Mt(r)).appendTo(r[u]);if(r[n][c]===rt||r[n][c]===st)Wt(r),Xt(r,r[n][c]===rt);else if(/^addPieces-([wb])([kqrbnp])$/[G](r[n][c])){var i=RegExp.$1,o=RegExp.$2;Wt(r),Vt(r,{color:i,piece:o})}else if(/^addSquareMarkers-([GRY])$/[G](r[n][c])){var a=RegExp.$1;Wt(r),$t(r,a)}else if(/^addArrowMarkers-([GRY])$/[G](r[n][c])){var a=RegExp.$1;Wt(r),Jt(r,a)}}}function Dt(e){t(B,e[u])[et](_)}function Pt(e,n,r){t(a,e[u])[v]($+n)[k]($+r)}function Ht(e){t(a,e[u])[et]("uichess-chessboard-hideCoordinates")}function Bt(e,t,n){typeof t===d?e[k](h)[k](f+n):typeof n===d?e[v](h)[v](f+t):e[v](f+t)[k](f+n)}function jt(e){var n=t(".uichess-chessboard-squareMarker",e[u]);n[v]("uichess-chessboard-markerColor-G"),n[v]("uichess-chessboard-markerColor-R"),n[v]("uichess-chessboard-markerColor-Y"),n[v](h);for(var r in e[i])if(e[i][A](r)){var s=e[i][r];Rt(e,r)[k](h)[k](f+s)}}function Ft(e,n,r,i){var s=O+n;if(typeof r===d){var o=n.substr(0,2),a=n.substr(2,2);if(o!==a){var f=zt(e,o,a);qt(e,s,i,f.x1,f.y1,f.x2,f.y2)}}else if(typeof i===d)t(s,e[u])[ct]();else{var l=j+s+b+i;t(s,e[u]).attr("class",l)}}function It(e){t(".uichess-chessboard-arrowMarker",e[u])[ct]();for(var n in e[r])if(e[r][A](n)){var i=n.substr(0,2),s=n.substr(2,2);if(i!==s){var o=zt(e,i,s),a=O+n;qt(e,a,e[r][n],o.x1,o.y1,o.x2,o.y2)}}}function qt(e,n,r,i,s,o,a){var f=j+n+b+r,l=C+r+")",c=t(document.createElementNS("http://www.w3.org/2000/svg","line"));return c.attr({x1:i,y1:s,x2:o,y2:a,"class":f,"marker-end":l}),t(H,e[u])[ut](c),c}function Rt(e,r){var i=e[n][D]?W:I,s=e[n][D]?q:z,a=i[at](r[1]),f=s[at](r[0]);return t(t(o,e[u]).get(a*8+f))}function Ut(e,t){var r=e[n][D]?W:I,i=e[n][D]?q:z;return{x:i[at](t[0])+.5,y:r[at](t[1])+.5}}function zt(e,t,n){var r=Ut(e,t),i=Ut(e,n);return i.x+=r.x<i.x?-0.3:r.x>i.x?.3:0,i.y+=r.y<i.y?-0.3:r.y>i.y?.3:0,{x1:r.x,y1:r.y,x2:i.x,y2:i.y}}function Wt(e){var r=e[n][D]?W:I,i=e[n][D]?q:z,s=0,a=0;t(o,e[u]).each(function(e,n){t(n).data(g,i[a]+r[s]),++a,a===8&&(a=0,++s)})}function Xt(e,r){t(J,e[u])[ft]({cursor:"move",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},revert:nt,revertDuration:0,zIndex:300});var i=t(a,e[u]).get(0),s=r?Qt:Kt;t(o,e[u]).droppable({hoverClass:F,accept:function(e){return t(e).closest(a).get(0)===i},drop:function(r,i){var o=t(r.target),u=i[ft];if(u.hasClass("uichess-chessboard-piece")){var a={from:u.parent().data(g),to:o.data(g)};s(e,a,M,e[n][S])}}})}function Vt(e,n){t(o,e[u]).mousedown(function(){Zt(e,n,t(this).data(g),t(this))})}function $t(e,n){t(o,e[u]).mousedown(function(){en(e,n,t(this).data(g),t(this))})}function Jt(e,r){function p(e){return(e-s.left)*8/c}function d(e){return(e-s.top)*8/h}var i=T,s=T,f=t(H,e[u]),c=f.width(),h=f.height();t(".uichess-chessboard-square .uichess-chessboard-handle",e[u])[ft]({cursor:"crosshair",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},helper:function(){return t('<div class="uichess-chessboard-sized"></div>')},start:function(n){i=t(n.target).closest(o).data(g),s=f.offset();var u=Ut(e,i);qt(e,"uichess-chessboard-draggedArrow",r,u.x,u.y,u.x,u.y)},drag:function(n){t(P,e[u]).attr({x2:p(n.pageX),y2:d(n.pageY)})},stop:function(){t(P,e[u])[ct]()}});var v=t(a,e[u]).get(0);t(o,e[u]).droppable({hoverClass:F,accept:function(e){return t(e).closest(a).get(0)===v},drop:function(n){var s=t(n.target).data(g);tn(e,r,i,s)}})}function Kt(e,n,r,i){if(n.from===n.to||e[s][g](n.from)==="-")return;e[s][g](n.to,e[s][g](n.from)),e[s][g](n.from,"-"),t(R,e[u])[ct](),Gt(e,n.from,n.to,r,i),nn(e)}function Qt(n,r,i,o){var a=n[s].isMoveLegal(r);if(!a)return;n[s][rt](a),t(R,n[u])[ct]();var f=Gt(n,a.from(),a.to(),i,o);a.type()===e[ht].CASTLING_MOVE&&Gt(n,a.rookFrom(),a.rookTo(),i,M),a.type()===e[ht].EN_PASSANT_CAPTURE&&Rt(n,a.enPassantSquare())[K]()[ut](vt),a.type()===e[ht].PROMOTION&&Yt(n,i,.8,function(){f[v]("uichess-chessboard-piece-p")[k]("uichess-chessboard-piece-"+a.promotion())}),t(B,n[u])[et](_),nn(n)}function Gt(r,i,s,o,u){var a=t(J,Rt(r,i));a.parent()[ut](vt),Rt(r,s)[K]()[ut](a);if(u){var f=zt(r,i,s);Yt(r,o,.5,function(){qt(r,"uichess-chessboard-moveArrow","B",f.x1,f.y1,f.x2,f.y2)})}if(o){var c=e[ot](i),h=e[ot](s),p=(c.r-h.r)*r[n][l]*(r[n][D]?1:-1),d=(h.c-c.c)*r[n][l]*(r[n][D]?1:-1);a.css("top",p+"px"),a.css("left",d+"px"),a.animate({top:"0px",left:"0px"},r[n][m])}return a}function Yt(e,t,r,i){t?setTimeout(i,e[n][m]*r):i()}function Zt(e,t,n,r){var i=e[s][g](n);typeof i=="object"&&i.color===t.color&&i.piece===t.piece?(e[s][g](n,"-"),r[K]()[ut](vt)):(e[s][g](n,t),r[K]()[ut](p+t.piece+U+t.color+'">'+vt+N)),nn(e)}function en(e,t,n,r){e[i][n]===t?(Bt(r,t),delete e[i][n]):(Bt(r,e[i][n],t),e[i][n]=t),rn(e)}function tn(e,t,n,i){var s=n+i;e[r][s]===t?(Ft(e,s,e[r][s]),delete e[r][s]):(Ft(e,s,e[r][s],t),e[r][s]=t),sn(e)}function nn(e){var t=e[n][L];e[n][L]=e[s].fen(),e[V](it,T,{oldValue:t,newValue:e[n][L]})}function rn(e){var t=e[n][y];e[n][y]=Et(e[i]),e[V](Q,T,{oldValue:t,newValue:e[n][y]})}function sn(e){var t=e[n][w];e[n][w]=Et(e[r]),e[V](Y,T,{oldValue:t,newValue:e[n][w]})}var n="options",r="_arrowMarkers",i="_squareMarkers",s="_position",o=".uichess-chessboard-square",u="element",a=".uichess-chessboard-table",f="uichess-chessboard-markerColor-",l="squareSize",c="interactionMode",h="uichess-chessboard-squareMarker",p='<div class="uichess-chessboard-sized uichess-chessboard-piece uichess-chessboard-piece-',d="undefined",v="removeClass",m="animationSpeed",g="square",y="squareMarkers",b=" uichess-chessboard-markerColor-",w="arrowMarkers",E="_initialGeometryInfo",S="showMoveArrow",x="showCoordinates",T=null,N="</div>",C="url(#uichess-chessboard-arrowMarkerEnd-",k="addClass",L="position",A="hasOwnProperty",O="uichess-chessboard-arrowMarker-",M=!1,_="uichess-chessboard-inactiveFlag",D="flip",P=".uichess-chessboard-draggedArrow",H=".uichess-chessboard-annotations",B=".uichess-chessboard-turnFlag",j="uichess-chessboard-arrowMarker ",F="uichess-chessboard-squareHover",I="87654321",q="hgfedcba",R=".uichess-chessboard-moveArrow",U=" uichess-chessboard-color-",z="abcdefgh",W="12345678",X='<div class="',V="_trigger",$="uichess-chessboard-size",J=".uichess-chessboard-piece",K="empty",Q="squareMarkersChange",G="test",Y="arrowMarkersChange",Z="uichess-chessboard",et="toggleClass",tt="castleRights",nt=!0,rt="play",it="positionChange",st="movePieces",ot="squareToCoordinates",ut="append",at="indexOf",ft="draggable",lt="enPassant",ct="remove",ht="movetype",pt=12,dt=64,vt='<div class="uichess-chessboard-handle"></div>',mt=/^\s*([GRY])([a-h][1-8])\s*$/,gt=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,yt=/^\s*[GRY]?([a-h][1-8])\s*$/,bt=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;t.chessboard={MINIMUM_SQUARE_SIZE:pt,MAXIMUM_SQUARE_SIZE:dt},t.widget("uichess.chessboard",{options:{position:K,squareMarkers:"",arrowMarkers:"",flip:M,squareSize:32,showCoordinates:nt,animationSpeed:200,showMoveArrow:M,interactionMode:"none"},_position:T,_squareMarkers:T,_arrowMarkers:T,_create:function(){this[u][k](Z).disableSelection(),this[n][L]=Ct(this,this[n][L]),this[n][y]=kt(this,this[n][y]),this[n][w]=Lt(this,this[n][w]),this[n][l]=xt(this[n][l]),this[n][c]=Tt(this[n][c]),this[n][m]=Nt(this[n][m]),this[n][D]=St(this[n][D],M),this[n][x]=St(this[n][x],nt),this[n][S]=St(this[n][S],M),_t(this)},_destroy:function(){this[u][K]()[v](Z).enableSelection()},_setOption:function(e,t){switch(e){case L:t=Ct(this,t);break;case y:t=kt(this,t);break;case w:t=Lt(this,t);break;case l:t=xt(t);break;case c:t=Tt(t);break;case m:t=Nt(t);break;case D:t=St(t,M);break;case x:t=St(t,nt);break;case S:t=St(t,M)}var r=this[n][e];if(r===t)return;this[n][e]=t;switch(e){case L:_t(this),this[V](it,T,{oldValue:r,newValue:this[n][L]});break;case D:_t(this),this[V]("flipChange",T,{oldValue:r,newValue:this[n][D]});break;case y:jt(this),this[V](Q,T,{oldValue:r,newValue:this[n][y]});break;case w:It(this),this[V](Y,T,{oldValue:r,newValue:this[n][w]});break;case l:Pt(this,r,t);break;case x:Ht(this);break;case m:break;case S:break;default:_t(this)}},turn:function(e){if(typeof e===d||e===T)return this[s].turn();e!==this[s].turn()&&(this[s].turn(e),Dt(this),nn(this))},castleRights:function(e,t,n){if(typeof n===d||n===T)return this[s][tt](e,t);n!==this[s][tt](e,t)&&(this[s][tt](e,t,n),nn(this))},enPassant:function(e){if(typeof e===d||e===T)return this[s][lt]();e!==this[s][lt]()&&(this[s][lt](e),nn(this))},movePiece:function(e){Kt(this,e,this[n][m]>0,this[n][S])},play:function(e){Qt(this,e,this[n][m]>0,this[n][S])},addSquareMarker:function(e){if(mt[G](e)){var t=RegExp.$1,n=RegExp.$2;this[i][n]!==t&&(Bt(Rt(this,n),this[i][n],t),this[i][n]=t,rn(this))}},removeSquareMarker:function(e){if(yt[G](e)){var t=RegExp.$1;typeof this[i][t]!==d&&(Bt(Rt(this,t),this[i][t]),delete this[i][t],rn(this))}},addArrowMarker:function(e){if(gt[G](e)){var t=RegExp.$1,n=RegExp.$2;this[r][n]!==t&&(Ft(this,n,this[r][n],t),this[r][n]=t,sn(this))}},removeArrowMarker:function(e){if(bt[G](e)){var t=RegExp.$1;typeof this[r][t]!==d&&(Ft(this,t,this[r][t]),delete this[r][t],sn(this))}},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[E]===undefined&&(r[E]={squareSize:r[n][l],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[E].width,s=t.size.height-r[E].height,o=Math.floor(i/9),u=Math.floor(s/8),a=r[E][l]+Math.min(o,u);r._setOption(l,a)})}})})(RPBChess,jQuery);