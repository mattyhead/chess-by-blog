(function(e,t){"use strict";function rt(e){return Math.min(Math.max(e,tt),nt)}function it(e){return e===R||e===H?e:"none"}var n="options",r="_position",i='<div class="uichess-chessboard-cell"></div></div>',s=" uichess-chessboard-size",o="position",u="squareSize",a='<div class="uichess-chessboard-cell"></div>',f=" uichess-chessboard-color-",l='<div class="uichess-chessboard-cell">',c=".uichess-chessboard-table",h="element",p="_initialGeometryInfo",d='<div class="uichess-chessboard-sparePiece uichess-chessboard-piece-',v="allowMoves",m='<div class="uichess-chessboard-trash uichess-chessboard-size',g='<div class="uichess-chessboard-piece uichess-chessboard-piece-',y='"></div>',b="_trigger",w=".uichess-chessboard-square",E="</div>",S=null,x="square",T="change",N="showCoordinates",C="uichess-chessboard-inactiveFlag",k=".uichess-chessboard-turnFlag",L=".uichess-chessboard-sparePiece",A="draggable",O="empty",M=".uichess-chessboard-piece",_="uichess-chessboard-piece",D="undefined",P="uichess-chessboard",H="legal",B="castleRights",j="sparePieces",F="_initializePosition",I="_fetchSquare",q=!1,R="all",U="_makePiecesDraggable",z="enPassant",W="appendTo",X="12345678",V="87654321",$="hgfedcba",J="abcdefgh",K="piece",Q="flip",G="_refresh",Y="move",Z="movetype",et="hasClass",tt=12,nt=64;t.chessboard={MINIMUM_SQUARE_SIZE:tt,MAXIMUM_SQUARE_SIZE:nt},t.widget("uichess.chessboard",{options:{position:O,flip:q,squareSize:32,showCoordinates:!0,allowMoves:"none",sparePieces:q},_position:S,_create:function(){this[h].addClass(P).disableSelection(),this[n][o]=this[F](this[n][o]),this[n][u]=rt(this[n][u]),this[n][v]=it(this[n][v]),this[G]()},_destroy:function(){this[h][O]().removeClass(P).enableSelection()},_setOption:function(e,t){switch(e){case o:t=this[F](t);break;case u:t=rt(t);break;case v:t=it(t)}this[n][e]=t,this[G](),e===o&&this[b](T,S,this[n][o])},_initializePosition:function(t){t=t.replace(/^\s+|\s+$/g,"");try{this[r]=new e.Position(t),t=this[r].fen()}catch(n){if(!(n instanceof e.exceptions.InvalidFEN))throw this[r]=S,n;this[r]=n}return t},turn:function(e){if(typeof e===D||e===S)return this[r].turn();e!==this[r].turn()&&(this[r].turn(e),this[n][o]=this[r].fen(),t(k,this[h]).toggleClass(C),this[b](T,S,this[n][o]))},castleRights:function(e,t,i){if(typeof i===D||i===S)return this[r][B](e,t);i!==this[r][B](e,t)&&(this[r][B](e,t,i),this[n][o]=this[r].fen(),this[b](T,S,this[n][o]))},enPassant:function(e){if(typeof e===D||e===S)return this[r][z]();e!==this[r][z]()&&(this[r][z](e),this[n][o]=this[r].fen(),this[b](T,S,this[n][o]))},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[p]===undefined&&(r[p]={squareSize:r[n][u],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[p].width,s=t.size.height-r[p].height,o=Math.floor(i/9),a=Math.floor(s/8),f=r[p][u]+Math.min(o,a);f=Math.min(Math.max(f,tt),nt),f!==r[n][u]&&(r[n][u]=f,r[G]())})},_destroyContent:function(){this[h][O]()},_buildErrorMessage:function(){var e='<div class="uichess-chessboard-error"><div class="uichess-chessboard-errorTitle">Error while analysing a FEN string.</div>';return this[r].message!==S&&(e+='<div class="uichess-chessboard-errorMessage">'+this[r].message+E),e+=E,e},_refresh:function(){this._destroyContent();if(this[r]===S)return;if(this[r]instanceof e.exceptions.InvalidFEN){t(this._buildErrorMessage())[W](this[h]);return}var o=this[n][Q]?X:V,c=this[n][Q]?$:J,p=this[n][u],b="pnbrqk 0",w='<div class="uichess-chessboard-table">';if(this[n][j]){w+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesTopRow">',this[n][N]&&(w+=a);var T=this[n][Q]?"w":"b";for(var C=0;C<8;++C)w+=l,b[C].match(/^[0-9]$/)?w+=m+p+y:b[C].match(/^[bknpqr]$/)&&(w+=d+b[C]+f+T+s+p+y),w+=E;w+=i}for(var k=0;k<8;++k){w+='<div class="uichess-chessboard-row">',this[n][N]&&(w+='<div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+o[k]+E);for(var C=0;C<8;++C){var L=c[C]+o[k],A=this[r][x](L),O=e.squareColor(L)==="w"?"light":"dark";w+='<div class="uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-size'+p+" uichess-chessboard-"+O+'Square">',A!=="-"&&(w+=g+A[K]+f+A.color+s+p+y),w+=E}w+=l;if(o[k]==="8"||o[k]==="1"){var T=o[k]==="8"?"b":"w",M=this[r].turn();w+='<div class="uichess-chessboard-turnFlag uichess-chessboard-color-'+T+s+p+(T===M?"":" uichess-chessboard-inactiveFlag")+y}w+="</div></div>"}if(this[n][N]){w+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow">',w+=a;for(var C=0;C<8;++C)w+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+c[C]+E;w+=i}if(this[n][j]){w+='<div class="uichess-chessboard-row uichess-chessboard-sparePiecesBottomRow">',this[n][N]&&(w+=a);var T=this[n][Q]?"b":"w";for(var C=0;C<8;++C)w+=l,b[C].match(/^[0-9]$/)?w+=m+p+y:b[C].match(/^[bknpqr]$/)&&(w+=d+b[C]+f+T+s+p+y),w+=E;w+=i}w+=E,t(w)[W](this[h]);var _=this[n][v]===R||this[n][v]===H,D=this[n][j];if(_||D)this._tagSquares(),this._makeSquareDroppable();_&&this[U](),D&&(this._tagSparePieces(),this._makeSparePiecesDraggable(),this._makeTrashDroppable())},_tagSquares:function(){var e=this[n][Q]?X:V,r=this[n][Q]?$:J,i=0,s=0;t(w,this[h]).each(function(){t(this).data(x,r[s]+e[i]),++s,s===8&&(s=0,++i)})},_tagSparePieces:function(){var e="pnbrqk",r=this[n][Q]?"wb":"bw",i=0,s=0;t(L,this[h]).each(function(){t(this).data(K,{piece:e[i],color:r[s]}),++i,i===6&&(i=0,++s)})},_fetchSquare:function(e){return t(w,this[h]).filter(function(){return t(this).data(x)===e})},_makeSquareDroppable:function(){var e=this,n=t(c,this[h]).get(0);t(w,this[h]).droppable({hoverClass:"uichess-chessboard-squareHover",accept:function(e){return t(e).closest(c).get(0)===n},drop:function(n,r){var i=t(n.target),s=r[A];if(s[et]("uichess-chessboard-sparePiece")){var o=r[A].data(K);e._doAddSparePiece(i.data(x),{piece:o[K],color:o.color},i)}if(s[et](_)){var u={from:s.parent().data(x),to:i.data(x)};u.from!==u.to&&e._doMove(u,s,i)}}})},_makeTrashDroppable:function(){var e=this,n=t(c,this[h]).get(0);t(".uichess-chessboard-trash",this[h]).droppable({hoverClass:"uichess-chessboard-trashHover",accept:function(e){return t(e)[et](_)&&t(e).closest(c).get(0)===n},drop:function(n,r){e._doRemovePiece(r[A].parent().data(x),r[A],t(n.target))}})},_makePiecesDraggable:function(e){t(M,e===undefined?this[h]:e)[A]({cursor:Y,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},revert:!0,revertDuration:0,zIndex:100})},_makeSparePiecesDraggable:function(e){t(L,e===undefined?this[h]:e)[A]({cursor:Y,cursorAt:{top:this[n][u]/2,left:this[n][u]/2},helper:"clone",revert:!0,revertDuration:0,zIndex:100})},_doMove:function(i,s,u){if(this[n][v]===R)this[r][x](i.to,this[r][x](i.from)),this[r][x](i.from,"-"),u[O]().append(s);else if(this[n][v]===H){var a=this[r].isMoveLegal(i);if(a===q){i.promotion="q",a=this[r].isMoveLegal(i);if(a===q)return}this[r].play(a),u[O]().append(s);if(a.type()===e[Z].CASTLING_MOVE){var f=this[I](a.rookFrom()),l=this[I](a.rookTo());l[O]().append(t(M,f))}a.type()===e[Z].EN_PASSANT_CAPTURE&&this[I](a.enPassantSquare())[O](),a.type()===e[Z].PROMOTION&&s.removeClass("uichess-chessboard-piece-p").addClass("uichess-chessboard-piece-"+a.promotion()),t(k,this[h]).toggleClass(C)}this[n][o]=this[r].fen(),this[b](Y,S,i),this[b](T,S,this[n][o])},_doAddSparePiece:function(e,i,a){this[r][x](e,i),t(g+i[K]+f+i.color+s+this[n][u]+y)[W](a[O]()),(this[n][v]===R||this[n][v]===H)&&this[U](a),this[n][o]=this[r].fen(),this[b]("add",S,{square:e,piece:i}),this[b](T,S,this[n][o])},_doRemovePiece:function(e,t,i){this[r][x](e,"-"),i[O]().append(t),this[n][o]=this[r].fen(),this[b]("remove",S,e),this[b](T,S,this[n][o])}})})(RPBChess,jQuery);