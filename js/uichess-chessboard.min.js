(function(e,t){"use strict";function gt(e,t){var n={},r=e.split(",");for(var i=0;i<r.length;++i)t[J](r[i])&&(n[RegExp.$2]=RegExp.$1);return n}function yt(e){var t=[];for(var n in e)e[st](n)&&t.push(e[n]+n);return t.join(",")}function bt(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?et:e==="false"||e==="0"||e==="off"?V:t):t}function wt(e){return Math.min(Math.max(e,lt),ct)}function Et(e){return e===tt||e===nt||/^addPieces-[wb][kqrbnp]$/[J](e)||/^add(?:Square|Arrow)Markers-[GRY]$/[J](e)?e:"none"}function St(t,n){n=n.replace(/^\s+|\s+$/g,"");try{t[r]=new e.Position(n),n=t[r].fen()}catch(i){if(!(i instanceof e.exceptions.InvalidFEN))throw t[r]=E,i;t[r]=i}return n}function xt(e,t){return e[s]=gt(t,pt),yt(e[s])}function Tt(e,t){return e[i]=gt(t,dt),yt(e[i])}function Nt(e){e[f][R]()}function Ct(e){var t='<div class="uichess-chessboard-error"><div class="uichess-chessboard-errorTitle">Error while analysing a FEN string.</div>';return e[r].message!==E&&(t+='<div class="uichess-chessboard-errorMessage">'+e[r].message+S),t+=S,t}function kt(t){var o=t[n][H]?_:F,u=t[n][H]?P:j,f="uichess-chessboard-table uichess-chessboard-size"+t[n][h];t[n][w]||(f+=" uichess-chessboard-hideCoordinates");var l=I+f+'">';for(var c=0;c<8;++c){l+='<div class="uichess-chessboard-row"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+o[c]+S;for(var d=0;d<8;++d){var v=u[d]+o[c],y=e.squareColor(v)==="w"?"light":"dark",b="uichess-chessboard-sized uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-"+y+"Square";v in t[s]&&(b+=" uichess-chessboard-squareMarker uichess-chessboard-markerColor-"+t[s][v]),l+=I+b+'">';var E=t[r][m](v);E==="-"?l+=ht:l+=p+E.piece+D+E.color+'">'+ht+S,l+=S}l+='<div class="uichess-chessboard-cell">';if(o[c]==="8"||o[c]==="1"){var x=o[c]==="8"?"b":"w",b="uichess-chessboard-sized uichess-chessboard-turnFlag uichess-chessboard-color-"+x;x!==t[r].turn()&&(b+=" uichess-chessboard-inactiveFlag"),l+=I+b+'"></div>'}l+="</div></div>"}l+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate"></div>';for(var d=0;d<8;++d)l+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+u[d]+S;l+='<div class="uichess-chessboard-cell"></div></div>',l+='<svg class="uichess-chessboard-annotations" viewBox="0 0 8 8">';for(var T in t[i])if(t[i][st](T)&&/^([a-h][1-8])([a-h][1-8])$/[J](T)){var N=RegExp.$1,C=RegExp.$2;if(N!==C){var k=Bt(t,N,C),b=a+N+C+g+t[i][T];l+='<line class="'+b+'" x1="'+k.x1+'" y1="'+k.y1+'" x2="'+k.x2+'" y2="'+k.y2+'" />'}}return l+="</svg>",l+=S,l}function Lt(i){Nt(i);if(i[r]===E)return;if(i[r]instanceof e.exceptions.InvalidFEN)t(Ct(i))[it](i[f]);else{t(kt(i))[it](i[f]);if(i[n][l]===tt||i[n][l]===nt)jt(i),Ft(i,i[n][l]===tt);else if(/^addPieces-([wb])([kqrbnp])$/[J](i[n][l])){var s=RegExp.$1,o=RegExp.$2;jt(i),It(i,{color:s,piece:o})}else if(/^addSquareMarkers-([GRY])$/[J](i[n][l])){var u=RegExp.$1;jt(i),qt(i,u)}else if(/^addArrowMarkers-([GRY])$/[J](i[n][l])){var u=RegExp.$1;jt(i),Rt(i,u)}}}function At(e){t(O,e[f])[G](k)}function Ot(e,n,r){t(u,e[f])[x](U+n)[B](U+r)}function Mt(e){t(u,e[f])[G]("uichess-chessboard-hideCoordinates")}function _t(e,t,n){typeof t===d?e[B](C)[B](c+n):typeof n===d?e[x](C)[x](c+t):e[x](c+t)[B](c+n)}function Dt(e,n,r,i){if(typeof r===d){var s=n.substr(0,2),o=n.substr(2,2);if(s!==o){var u=Bt(e,s,o),l=a+n+g+i,c=t(document[rt](z,"line"));c.attr({x1:u.x1,y1:u.y1,x2:u.x2,y2:u.y2,"class":l}),t(A,e[f])[X](c)}}else if(typeof i===d)t(L+n,e[f]).remove();else{var l=a+n+g+i;t(L+n,e[f]).attr("class",l)}}function Pt(e,r){var i=e[n][H]?_:F,s=e[n][H]?P:j,u=i[at](r[1]),a=s[at](r[0]);return t(t(o,e[f]).get(u*8+a))}function Ht(e,t){var r=e[n][H]?_:F,i=e[n][H]?P:j;return{x:i[at](t[0])+.5,y:r[at](t[1])+.5}}function Bt(e,t,n){var r=Ht(e,t),i=Ht(e,n);return i.x+=r.x<i.x?-0.3:r.x>i.x?.3:0,i.y+=r.y<i.y?-0.3:r.y>i.y?.3:0,{x1:r.x,y1:r.y,x2:i.x,y2:i.y}}function jt(e){var r=e[n][H]?_:F,i=e[n][H]?P:j,s=0,u=0;t(o,e[f]).each(function(e,n){t(n).data(m,i[u]+r[s]),++u,u===8&&(u=0,++s)})}function Ft(e,r){t(W,e[f])[ot]({cursor:"move",cursorAt:{top:e[n][h]/2,left:e[n][h]/2},revert:et,revertDuration:0,zIndex:300});var i=t(u,e[f]).get(0),s=r?zt:Ut;t(o,e[f]).droppable({hoverClass:M,accept:function(e){return t(e).closest(u).get(0)===i},drop:function(n,r){var i=t(n.target),o=r[ot];if(o.hasClass("uichess-chessboard-piece")){var u={from:o.parent().data(m),to:i.data(m)};u.from!==u.to&&s(e,u,o,i)}}})}function It(e,n){t(o,e[f]).mousedown(function(){Wt(e,n,t(this).data(m),t(this))})}function qt(e,n){t(o,e[f]).mousedown(function(){Xt(e,n,t(this).data(m),t(this))})}function Rt(e,r){function p(e){return(e-s.left)*8/l}function d(e){return(e-s.top)*8/c}var i=E,s=E,a=t(A,e[f]),l=a.width(),c=a.height();t(".uichess-chessboard-square .uichess-chessboard-handle",e[f])[ot]({cursor:"crosshair",cursorAt:{top:e[n][h]/2,left:e[n][h]/2},helper:function(){return t('<div class="uichess-chessboard-sized"></div>')},start:function(n){i=t(n.target).closest(o).data(m),s=a.offset();var u="uichess-chessboard-arrowMarker uichess-chessboard-markerColor-"+r,f=Ht(e,i),l=t(document[rt](z,"line"));l.attr({x1:f.x,y1:f.y,x2:f.x,y2:f.y,"class":u,id:"uichess-chessboard-draggedArrowMarker"}),l[it](a)},drag:function(e){t(T).attr({x2:p(e.pageX),y2:d(e.pageY)})},stop:function(){t(T).remove()}});var v=t(u,e[f]).get(0);t(o,e[f]).droppable({hoverClass:M,accept:function(e){return t(e).closest(u).get(0)===v},drop:function(n){var s=t(n.target).data(m);Vt(e,r,i,s)}})}function Ut(e,t,n,i){e[r][m](t.to,e[r][m](t.from)),e[r][m](t.from,"-"),n.parent()[X](ht),i[R]()[X](n),$t(e)}function zt(n,i,s,o){var u=n[r].isMoveLegal(i);if(u===V){i.promotion="q",u=n[r].isMoveLegal(i);if(u===V)return}n[r][tt](u),s.parent()[X](ht),o[R]()[X](s);if(u.type()===e[ft].CASTLING_MOVE){var a=Pt(n,u.rookFrom()),l=Pt(n,u.rookTo());a[X](ht),l[R]()[X](t(W,a))}u.type()===e[ft].EN_PASSANT_CAPTURE&&Pt(n,u.enPassantSquare())[R]()[X](ht),u.type()===e[ft].PROMOTION&&s[x]("uichess-chessboard-piece-p")[B]("uichess-chessboard-piece-"+u.promotion()),t(O,n[f])[G](k),$t(n)}function Wt(e,t,n,i){var s=e[r][m](n);typeof s=="object"&&s.color===t.color&&s.piece===t.piece?(e[r][m](n,"-"),i[R]()[X](ht)):(e[r][m](n,t),i[R]()[X](p+t.piece+D+t.color+'">'+ht+S)),$t(e)}function Xt(e,t,n,r){e[s][n]===t?(_t(r,t),delete e[s][n]):(_t(r,e[s][n],t),e[s][n]=t),Jt(e)}function Vt(e,t,n,r){var s=n+r;e[i][s]===t?(Dt(e,s,e[i][s]),delete e[i][s]):(Dt(e,s,e[i][s],t),e[i][s]=t),Kt(e)}function $t(e){var t=e[n][N];e[n][N]=e[r].fen(),e[q](Z,E,{oldValue:t,newValue:e[n][N]})}function Jt(e){var t=e[n][v];e[n][v]=yt(e[s]),e[q]($,E,{oldValue:t,newValue:e[n][v]})}function Kt(e){var t=e[n][y];e[n][y]=yt(e[i]),e[q](K,E,{oldValue:t,newValue:e[n][y]})}var n="options",r="_position",i="_arrowMarkers",s="_squareMarkers",o=".uichess-chessboard-square",u=".uichess-chessboard-table",a="uichess-chessboard-arrowMarker uichess-chessboard-arrowMarker-",f="element",l="interactionMode",c="uichess-chessboard-markerColor-",h="squareSize",p='<div class="uichess-chessboard-sized uichess-chessboard-piece uichess-chessboard-piece-',d="undefined",v="squareMarkers",m="square",g=" uichess-chessboard-markerColor-",y="arrowMarkers",b="_initialGeometryInfo",w="showCoordinates",E=null,S="</div>",x="removeClass",T="#uichess-chessboard-draggedArrowMarker",N="position",C="uichess-chessboard-squareMarker",k="uichess-chessboard-inactiveFlag",L=".uichess-chessboard-arrowMarker-",A=".uichess-chessboard-annotations",O=".uichess-chessboard-turnFlag",M="uichess-chessboard-squareHover",_="12345678",D=" uichess-chessboard-color-",P="hgfedcba",H="flip",B="addClass",j="abcdefgh",F="87654321",I='<div class="',q="_trigger",R="empty",U="uichess-chessboard-size",z="http://www.w3.org/2000/svg",W=".uichess-chessboard-piece",X="append",V=!1,$="squareMarkersChange",J="test",K="arrowMarkersChange",Q="uichess-chessboard",G="toggleClass",Y="castleRights",Z="positionChange",et=!0,tt="play",nt="movePieces",rt="createElementNS",it="appendTo",st="hasOwnProperty",ot="draggable",ut="enPassant",at="indexOf",ft="movetype",lt=12,ct=64,ht='<div class="uichess-chessboard-handle"></div>',pt=/^\s*([GRY])([a-h][1-8])\s*$/,dt=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,vt=/^\s*[GRY]?([a-h][1-8])\s*$/,mt=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;t.chessboard={MINIMUM_SQUARE_SIZE:lt,MAXIMUM_SQUARE_SIZE:ct},t.widget("uichess.chessboard",{options:{position:R,squareMarkers:"",arrowMarkers:"",flip:V,squareSize:32,showCoordinates:et,interactionMode:"none"},_position:E,_squareMarkers:E,_arrowMarkers:E,_create:function(){this[f][B](Q).disableSelection(),this[n][N]=St(this,this[n][N]),this[n][v]=xt(this,this[n][v]),this[n][y]=Tt(this,this[n][y]),this[n][h]=wt(this[n][h]),this[n][l]=Et(this[n][l]),this[n][H]=bt(this[n][H],V),this[n][w]=bt(this[n][w],et),Lt(this)},_destroy:function(){this[f][R]()[x](Q).enableSelection()},_setOption:function(e,t){switch(e){case N:t=St(this,t);break;case v:t=xt(this,t);break;case y:t=Tt(this,t);break;case h:t=wt(t);break;case l:t=Et(t);break;case H:t=bt(t,V);break;case w:t=bt(t,et)}var r=this[n][e];if(r===t)return;this[n][e]=t;switch(e){case N:Lt(this),this[q](Z,E,{oldValue:r,newValue:this[n][N]});break;case v:Lt(this),this[q]($,E,{oldValue:r,newValue:this[n][v]});break;case y:Lt(this),this[q](K,E,{oldValue:r,newValue:this[n][y]});break;case H:Lt(this),this[q]("flipChange",E,{oldValue:r,newValue:this[n][H]});break;case h:Ot(this,r,t);break;case w:Mt(this);break;default:Lt(this)}},turn:function(e){if(typeof e===d||e===E)return this[r].turn();e!==this[r].turn()&&(this[r].turn(e),At(this),$t(this))},castleRights:function(e,t,n){if(typeof n===d||n===E)return this[r][Y](e,t);n!==this[r][Y](e,t)&&(this[r][Y](e,t,n),$t(this))},enPassant:function(e){if(typeof e===d||e===E)return this[r][ut]();e!==this[r][ut]()&&(this[r][ut](e),$t(this))},addSquareMarker:function(e){if(pt[J](e)){var t=RegExp.$1,n=RegExp.$2;this[s][n]!==t&&(_t(Pt(this,n),this[s][n],t),this[s][n]=t,Jt(this))}},removeSquareMarker:function(e){if(vt[J](e)){var t=RegExp.$1;typeof this[s][t]!==d&&(_t(Pt(this,t),this[s][t]),delete this[s][t],Jt(this))}},addArrowMarker:function(e){if(dt[J](e)){var t=RegExp.$1,n=RegExp.$2;this[i][n]!==t&&(Dt(this,n,this[i][n],t),this[i][n]=t,Kt(this))}},removeArrowMarker:function(e){if(mt[J](e)){var t=RegExp.$1;typeof this[i][t]!==d&&(Dt(this,t,this[i][t]),delete this[i][t],Kt(this))}},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[b]===undefined&&(r[b]={squareSize:r[n][h],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[b].width,s=t.size.height-r[b].height,o=Math.floor(i/9),u=Math.floor(s/8),a=r[b][h]+Math.min(o,u);r._setOption(h,a)})}})})(RPBChess,jQuery);