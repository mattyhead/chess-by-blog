(function(e,t,n){"use strict";function mt(e){return e===o||e==="?"?o:e}function gt(e){if(e===o||e==="????.??.??")return o;if(e.match(/([0-9]{4})\.([0-9]{2})\.([0-9]{2})/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3);return t.isValid()?St(t.format("LL")):e}if(e.match(/([0-9]{4})\.([0-9]{2})\.\?\?/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-01");return t.isValid()?St(t.format("MMMM YYYY")):e}return e.match(/([0-9]{4})\.\?\?\.\?\?/)?RegExp.$1:e}function yt(e){switch(e){case"*":return o;case"1/2-1/2":return"&#189;&#8211;&#189;";case"1-0":return"1&#8211;0";case"0-1":return"0&#8211;1";default:return e}}function bt(e){return e===o||e==="-"?o:e}function Et(e){return e===o?o:e in wt?wt[e]:"$"+e}function St(e){return e[x]===0?"":e.charAt(0).toUpperCase()+e.slice(1)}function xt(e,t,n,r){var i=t-n,s="...";i<=0&&(i=0,s="");var o=t+1+r,u="...";o>=e[x]&&(o=e[x],u="");var a=s+e.substr(i,o-i)+u;return a=a[I](/\n|\t/g," "),a+"\n"+(new Array(1+s[x]+t-i)).join(" ")+"^"}function Tt(e){var n=t.Color(e);return n.lightness()>.5?"black":"white"}function Nt(e){switch(e){case O:case G:case J:return e;default:return z}}function Ct(e){switch(e){case"merida":case"pirat":break;default:e="alpha"}var t='<span class="uichess-chessgame-'+e+'Font">',n=p,r={K:t+"K"+n,Q:t+"Q"+n,R:t+"R"+n,B:t+"B"+n,N:t+"N"+n,P:t+"P"+n};return{font:e,pieceSymbolTable:r}}function kt(e){return{flip:e[$],squareSize:e.squareSize,showCoordinates:e.showCoordinates}}function Lt(e){if(e===undefined||e===o)e=t(d);e.attr("style",o).attr("id",o)[R](y)}function At(){return'<div class="uichess-chessgame-navigationBoard"></div><div class="uichess-chessgame-navigationButtons"><button class="uichess-chessgame-navigationButtonFrst">&lt;&lt;</button><button class="uichess-chessgame-navigationButtonPrev">&lt;</button><button class="uichess-chessgame-navigationButtonNext">&gt;</button><button class="uichess-chessgame-navigationButtonLast">&gt;&gt;</button>'+c}function Ot(){function n(e){var n=t(d).closest(".uichess-chessgame");n[b](e);var i=t(r,n),s=!0;i.hasClass("uichess-chessgame-initialMove")&&(i=n,s=Z);var o=i.offset();o.top<t(window).scrollTop()?t(ot).animate({scrollTop:o.top},200):s&&o.top+i.height()>t(window).scrollTop()+window.innerHeight&&t(ot).animate({scrollTop:o.top+i.height()-window.innerHeight},200)}if(t(s)[x]!==0)return;t('<div id="uichess-chessgame-navigationFrame">'+At()+c)[et](t("body")),t(s)[W]({create:function(e){t(e.target).parent().css(w,st)},resizeStart:function(e){t(e.target).parent().css(w,st)},resizeStop:function(e){t(e.target).parent().css(w,st)},autoOpen:Z,dialogClass:t[b].navigationFrameClass,width:"auto",close:function(){Lt()}});var e=t(g);e[E](kt(t[b].navigationFrameOptions)),e[E]("sizeControlledByContainer",t(s),"dialogresize"),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonFrst")[K](function(e){e[v](),n(lt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonPrev")[K](function(e){e[v](),n(nt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonNext")[K](function(e){e[v](),n(pt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonLast")[K](function(e){e[v](),n(dt)})}var r=".uichess-chessgame-selectedMove",i="navigationBoard",s="#uichess-chessgame-navigationFrame",o=null,u="options",a="element",f="_pieceSymbolTable",l="navigationBoardOptions",c="</div>",h="_updateNavigationBoard",p="</span>",d="#uichess-chessgame-navigationFrameTarget",v="preventDefault",m="_game",g="#uichess-chessgame-navigationFrame .uichess-chessgame-navigationBoard",y="uichess-chessgame-selectedMove",b="chessgame",w="position",E="chessboard",S=".uichess-chessgame-move",x="length",T="_buildPositionInformation",N="nextMove",C="prevMove",k="diagramOptions",L=".uichess-chessgame-navigationBoard",A='<div class="uichess-chessgame-',O="frame",M="option",_=".uichess-chessgame-initialMove",D="data",P="undefined",H="pieceSymbols",B="isLongVariation",j="_initializePieceSymbols",F="uichess-chessgame",I="replace",q="header",R="removeClass",U="isLongComment",z="none",W="dialog",X="_playerNameHeader",V="comment",$="flip",J="floatRight",K="click",Q="pieceSymbolTable",G="floatLeft",Y="_destroyContent",Z=!1,et="appendTo",tt="_initializePGN",nt="goPreviousMove",rt="addClass",it="PIECE_SYMBOLS",st="fixed",ot="html, body",ut="squareMarkers",at="arrowMarkers",ft="_buildVariation",lt="goFirstMove",ct="_buildComment",ht="children",pt="goNextMove",dt="goLastMove",vt="mainVariation";t[b]={navigationFrameOptions:{},navigationFrameClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"}}};var wt={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};t.widget("uichess.chessgame",{options:{pgn:"*",navigationBoard:z,navigationBoardOptions:{},diagramOptions:{},pieceSymbols:"native"},_game:o,_pieceSymbolTable:o,_create:function(){this[a][rt](F),this[u].pgn=this[tt](this[u].pgn),this[u][H]=this[j](this[u][H]),this[u][i]=Nt(this[u][i]),this[u][l]=kt(this[u][l]),this[u][k]=kt(this[u][k]),this._refresh()},_destroy:function(){this[Y](),this[a][R](F)},_setOption:function(e,t){switch(e){case"pgn":t=this[tt](t);break;case H:t=this[j](t);break;case i:t=Nt(t);break;case l:t=kt(t);break;case k:t=kt(t)}this[u][e]=t,this._refresh()},goFirstMove:function(){var e=t(r,this[a]);if(e[x]===0)return;while(e[D](C)!==undefined)e=e[D](C);this[h](e)},goPreviousMove:function(){this[h](t(r,this[a])[D](C))},goNextMove:function(){this[h](t(r,this[a])[D](N))},goLastMove:function(){var e=t(r,this[a]);if(e[x]===0)return;while(e[D](N)!==undefined)e=e[D](N);this[h](e)},_initializePGN:function(t){typeof t!="string"&&(t="*"),t=t[I](/^\s+|\s+$/g,"");try{this[m]=e.pgn.parseOne(t)}catch(n){if(!(n instanceof e.exceptions.InvalidPGN))throw this[m]=o,n;this[m]=n}return t},_initializePieceSymbols:function(e){var n=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(e)){e=e.toUpperCase(),this[f]={};for(var r=0;r<6;++r)this[f][n[r]]=e.substr(r+1,1)}else if(/^:\w+$/.test(e)){var i=Ct(e.substr(1));e=":"+i.font,this[f]=i[Q]}else switch(e){case"figurines":this[f]=Ct(t[b].chessFont)[Q];break;case"localized":this[f]={};for(var r=0;r<6;++r){var s=n[r];this[f][s]=s in t[b].i18n[it]?t[b].i18n[it][s]:s}break;default:this[f]={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},e="native"}return e},_destroyContent:function(){var e=t(d,this[a]);e[x]!==0&&t(s)[W]("close"),this[a].empty()},_refresh:function(){this[Y]();if(this[m]===o)return;if(this[m]instanceof e.exceptions.InvalidPGN){t(this._buildErrorMessage())[et](this[a]);return}var n="";n+=this[X]("White"),n+=this[X]("Black"),n+=this._eventHeader(),n+=this._datePlaceHeader(),n+=this._annotatorHeader(),n!==""&&(n='<div class="uichess-chessgame-headers">'+n+c);var r=this._buildInitialMove(),s=this._buildBody(),f="",l="";switch(this[u][i]){case G:case J:l=A+this[u][i][I]("float","clear")+'"></div>',f='<div class="uichess-chessgame-navigationBox uichess-chessgame-'+this[u][i]+'">'+At()+c}t(f+r+n+s+l)[et](this[a]),this._makeDiagrams(),this[u][i]!==z&&(this._makeMovesClickable(),this._makeMovesRelated(),this[u][i]!==O&&this._makeNavigationBoxWidgets())},_makeDiagrams:function(){var e=this;t(".uichess-chessgame-comment .uichess-chessgame-diagramAnchor",this[a]).each(function(n,r){var i=t(r),s=i.closest(".uichess-chessgame-comment"),o=s[D](w),a=s[D]("csl"),f=s[D]("cal"),l={position:o};typeof a!==P&&(l[ut]=a),typeof f!==P&&(l[at]=f),t.extend(l,e[u][k]);try{t.extend(l,kt(t.parseJSON(i.text())))}catch(c){}i.empty()[R]("uichess-chessgame-diagramAnchor")[rt]("uichess-chessgame-diagram")[E](l)})},_makeMovesClickable:function(){var e=this;t(S,this[a])[K](function(){e[h](t(this))})},_makeMovesRelated:function(){t(".uichess-chessgame-variation").each(function(e,n){var r=t(n),i=r.is("div")?r[ht](".uichess-chessgame-moveGroup")[ht](S):r[ht](S),s=o;i.each(function(e,n){var r=t(n);s!==o&&(r[D](C,s),s[D](N,r)),s=r})});var e=t(_,this[a]),n=t(".uichess-chessgame-variation .uichess-chessgame-move",this[a]);if(n[x]!==0){var r=n.first();r[D](C,e),e[D](N,r)}},_makeNavigationBoxWidgets:function(){t(L,this[a])[E](this[u][l]);var e=this;t(".uichess-chessgame-navigationButtonFrst",this[a])[K](function(t){t[v](),e[lt]()}),t(".uichess-chessgame-navigationButtonPrev",this[a])[K](function(t){t[v](),e[nt]()}),t(".uichess-chessgame-navigationButtonNext",this[a])[K](function(t){t[v](),e[pt]()}),t(".uichess-chessgame-navigationButtonLast",this[a])[K](function(t){t[v](),e[dt]()}),this[h](t(_,this[a]))},_buildErrorMessage:function(){var e='<div class="uichess-chessgame-error"><div class="uichess-chessgame-errorTitle">Error while analysing a PGN string.</div>';return this[m].message!==o&&(e+='<div class="uichess-chessgame-errorMessage">'+this[m].message+c),this[m].index!==o&&this[m].index>=0&&(e+='<div class="uichess-chessgame-errorAt">',this[m].index>=this[m].pgn[x]?e+="Occurred at the end of the string.":e+="Occurred at position "+this[m].index+":"+'<div class="uichess-chessgame-errorAtCode">'+xt(this[m].pgn,this[m].index,10,40)+c,e+=c),e+=c,e},_playerNameHeader:function(e){var t=mt(this[m][q](e));if(t===o)return"";var n=A+e.toLowerCase()+'Player">'+'<span class="uichess-chessgame-colorTag"></span> '+'<span class="uichess-chessgame-playerName">'+t+p,r=bt(this[m][q](e+"Title")),i=mt(this[m][q](e+"Elo"));if(r!==o||i!==o)n+='<span class="uichess-chessgame-titleRatingGroup">',r!==o&&(n+='<span class="uichess-chessgame-playerTitle">'+r+p),i!==o&&(n+='<span class="uichess-chessgame-playerRating">'+i+p),n+=p;return n+=c,n},_eventHeader:function(){var e=mt(this[m][q]("Event"));if(e===o)return"";var t=mt(this[m][q]("Round")),n='<div class="uichess-chessgame-event">'+e;return t!==o&&(n+='<span class="uichess-chessgame-round">'+t+p),n+=c,n},_datePlaceHeader:function(){var e=gt(this[m][q]("Date")),t=mt(this[m][q]("Site"));if(e===o&&t===o)return"";var n='<div class="uichess-chessgame-datePlaceGroup">';return e!==o&&(n+='<span class="uichess-chessgame-date">'+e+p),t!==o&&(n+='<span class="uichess-chessgame-site">'+t+p),n+=c,n},_annotatorHeader:function(){var e=mt(this[m][q]("Annotator"));if(e===o)return"";var n='<div class="uichess-chessgame-annotator">'+t[b].i18n.ANNOTATED_BY[I](/%1\$s/g,'<span class="uichess-chessgame-annotatorName">'+e+p)+c;return n},_buildBody:function(){var e=this[ft](this[m][vt](),!0,yt(this[m].result()));if(e.content==="")return"";var t="uichess-chessgame-body";return e.divCount>1&&(t+=" uichess-chessgame-moreSpace"),this[u][i]!==z&&(t+=" uichess-chessgame-clickableMoves"),'<div class="'+t+'">'+e.content+c},_buildVariation:function(e,t,n){function f(){s&&!u&&(i+='<div class="uichess-chessgame-moveGroup">',u=!0,++a)}function l(){u&&(i+=c,u=Z)}if(e[V]()===o&&e.first()===o&&n===o)return t?{content:"",divCount:0}:"";var r=e[B]()?"div":"span",i="<"+r+' class="uichess-chessgame-variation'+(t?"":" uichess-chessgame-subVariation")+'">',s=e[B](),u=Z,a=0;e[V]()!==o&&(e[U]()?++a:f(),i+=this[ct](e));var h=!0,d=e.first();while(d!==o){f(),i+=this._buildMove(d,h),d[V]()!==o&&(d[U]()&&(l(),++a),i+=this[ct](d));var v=0,m=d.variations();for(var g=0;g<m[x];++g){var y=this[ft](m[g],Z,o);y!==""&&(m[g][B]()?(l(),++a):f(),i+=y,++v)}h=d[V]()!==o||v>0,d=d.next()}return t&&n!==o&&(f(),i+='<span class="uichess-chessgame-result">'+n+p),l(),i+="</"+r+">",t?{content:i,divCount:a}:i},_buildPositionInformation:function(e){var t='data-position="'+e[w]().fen()+'"',n=e.tag("csl");n!==o&&(t+=' data-csl="'+n+'"');var r=e.tag("cal");return r!==o&&(t+=' data-cal="'+r+'"'),t},_buildComment:function(e){var t=e[U]()?"div":"span";return"<"+t+' class="uichess-chessgame-comment" '+this[T](e)+">"+e[V]()+"</"+t+">"},_buildMove:function(e,t){var n='<span class="uichess-chessgame-move" '+this[T](e)+">",r=t||e.moveColor()==="w",i="uichess-chessgame-moveNumber"+(r?"":" uichess-chessgame-hidden"),s=e.fullMoveNumber()+(e.moveColor()==="w"?".":"…");n+='<span class="'+i+'">'+s+p;var o=this[f];n+=e.move()[I](/[KQRBNP]/g,function(e){return o[e]});var u=e.nags();for(var a=0;a<u[x];++a)n+=" "+Et(u[a]);return n+=p,n},_buildInitialMove:function(){return'<div class="uichess-chessgame-move uichess-chessgame-initialMove" '+this[T](this[m][vt]())+">"+t[b].i18n.INITIAL_POSITION+c},_updateNavigationBoard:function(e){if(e===undefined||e===o||e.hasClass(y))return;this[u][i]===O&&Ot(),this._updateNavigationBoardWidget(e),this._updateSelectedMove(e);if(this[u][i]===O){var n=t(s);n[W]("isOpen")||(n[W](M,w,{my:"center",at:"center",of:window}),n[W]("open")),t(".ui-dialog-title",n.closest(".ui-dialog")).empty().append(e.html())}},_updateNavigationBoardWidget:function(e){var n=this[u][i]===O?t(g):t(L,this[a]);n[E](M,w,e[D](w));var r=e[D]("csl"),s=e[D]("cal");n[E](M,ut,typeof r===P?"":r),n[E](M,at,typeof s===P?"":s),this[u][l][$]!==n[E](M,$)&&n[E](M,$,this[u][l][$])},_updateSelectedMove:function(e){var n=this[u][i]===O;Lt(n?o:t(r,this[a])),e[rt](y),n&&e.attr("id","uichess-chessgame-navigationFrameTarget");var s=e.css("color");e.css("background-color",s),e.css("color",Tt(s))}})})(RPBChess,jQuery,moment);