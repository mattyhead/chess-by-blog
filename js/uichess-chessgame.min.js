(function(e,t,n){"use strict";function ct(e){return e===s||e==="?"?s:e}function ht(e){if(e===s||e==="????.??.??")return s;if(e.match(/([0-9]{4})\.([0-9]{2})\.([0-9]{2})/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3);return t.isValid()?gt(t.format("LL")):e}if(e.match(/([0-9]{4})\.([0-9]{2})\.\?\?/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-01");return t.isValid()?gt(t.format("MMMM YYYY")):e}return e.match(/([0-9]{4})\.\?\?\.\?\?/)?RegExp.$1:e}function pt(e){switch(e){case s:case"*":return s;case"1/2-1/2":return"&#189;&#8211;&#189;";case"1-0":return"1&#8211;0";case"0-1":return"0&#8211;1";default:return e}}function dt(e){return e===s||e==="-"?s:e}function mt(e){return e===s?s:e in vt?vt[e]:"$"+e}function gt(e){return e[x]===0?"":e.charAt(0).toUpperCase()+e.slice(1)}function yt(e,t,n,r){var i=t-n,s="...";i<=0&&(i=0,s="");var o=t+1+r,u="...";o>=e[x]&&(o=e[x],u="");var a=s+e.substr(i,o-i)+u;return a=a[j](/\n|\t/g," "),a+"\n"+(new Array(1+s[x]+t-i)).join(" ")+"^"}function bt(e){var n=t.Color(e);return n.lightness()>.5?"black":"white"}function wt(e){switch(e){case A:case Q:case J:return e;default:return U}}function Et(e){switch(e){case"merida":case"pirat":break;default:e="alpha"}var t='<span class="uichess-chessgame-'+e+'Font">',n=h,r={K:t+"K"+n,Q:t+"Q"+n,R:t+"R"+n,B:t+"B"+n,N:t+"N"+n,P:t+"P"+n};return{font:e,pieceSymbolTable:r}}function St(e){return{squareSize:e.squareSize,showCoordinates:e.showCoordinates}}function xt(e){if(e===undefined||e===s)e=t(p);e.attr("style",s).attr("id",s)[z](b)}function Tt(){return'<div class="uichess-chessgame-navigationBoard"></div><div class="uichess-chessgame-navigationButtons"><button class="uichess-chessgame-navigationButtonFrst">&lt;&lt;</button><button class="uichess-chessgame-navigationButtonPrev">&lt;</button><button class="uichess-chessgame-navigationButtonNext">&gt;</button><button class="uichess-chessgame-navigationButtonLast">&gt;&gt;</button>'+l}function Nt(){function n(e){t(p).closest(".uichess-chessgame")[w](e)}if(t(i)[x]!==0)return;t('<div id="uichess-chessgame-navigationFrame">'+Tt()+l)[tt](t("body")),t(i)[W]({create:function(e){t(e.target).parent().css(g,nt)},resizeStart:function(e){t(e.target).parent().css(g,nt)},resizeStop:function(e){t(e.target).parent().css(g,nt)},autoOpen:q,dialogClass:t[w].navigationFrameClass,width:"auto",close:function(){xt()}});var e=t(m);e[S](St(t[w].navigationFrameOptions)),e[S]("sizeControlledByContainer",t(i),"dialogresize"),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonFrst")[$](function(e){e[d](),n(st)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonPrev")[$](function(e){e[d](),n(Y)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonNext")[$](function(e){e[d](),n(lt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonLast")[$](function(e){e[d](),n(ot)})}var r="navigationBoard",i="#uichess-chessgame-navigationFrame",s=null,o=".uichess-chessgame-selectedMove",u="options",a="element",f="_pieceSymbolTable",l="</div>",c="_updateNavigationBoard",h="</span>",p="#uichess-chessgame-navigationFrameTarget",d="preventDefault",v="_game",m="#uichess-chessgame-navigationFrame .uichess-chessgame-navigationBoard",g="position",y="navigationBoardOptions",b="uichess-chessgame-selectedMove",w="chessgame",E=".uichess-chessgame-move",S="chessboard",x="length",T="diagramOptions",N="prevMove",C="nextMove",k=".uichess-chessgame-navigationBoard",L='<div class="uichess-chessgame-',A="frame",O=".uichess-chessgame-initialMove",M="pieceSymbols",_="data",D="isLongVariation",P="_initializePieceSymbols",H='">',B="uichess-chessgame",j="replace",F="header",I="option",q=!1,R="isLongComment",U="none",z="removeClass",W="dialog",X="_playerNameHeader",V="comment",$="click",J="floatRight",K="pieceSymbolTable",Q="floatLeft",G="_destroyContent",Y="goPreviousMove",Z="addClass",et="_initializePGN",tt="appendTo",nt="fixed",rt="PIECE_SYMBOLS",it="_buildVariation",st="goFirstMove",ot="goLastMove",ut="children",at="flip",ft="_buildComment",lt="goNextMove";t[w]={navigationFrameOptions:{},navigationFrameClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"}}};var vt={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};t.widget("uichess.chessgame",{options:{pgn:"*",navigationBoard:U,navigationBoardOptions:{},diagramOptions:{},flip:q,pieceSymbols:"native"},_game:s,_pieceSymbolTable:s,_create:function(){this[a][Z](B),this[u].pgn=this[et](this[u].pgn),this[u][M]=this[P](this[u][M]),this[u][r]=wt(this[u][r]),this[u][y]=St(this[u][y]),this[u][T]=St(this[u][T]),this._refresh()},_destroy:function(){this[G](),this[a][z](B)},_setOption:function(e,t){switch(e){case"pgn":t=this[et](t);break;case M:t=this[P](t);break;case r:t=wt(t);break;case y:t=St(t);break;case T:t=St(t)}this[u][e]=t,this._refresh()},goFirstMove:function(){var e=t(o,this[a]);if(e[x]===0)return;while(e[_](N)!==undefined)e=e[_](N);this[c](e)},goPreviousMove:function(){this[c](t(o,this[a])[_](N))},goNextMove:function(){this[c](t(o,this[a])[_](C))},goLastMove:function(){var e=t(o,this[a]);if(e[x]===0)return;while(e[_](C)!==undefined)e=e[_](C);this[c](e)},_initializePGN:function(t){typeof t!="string"&&(t="*"),t=t[j](/^\s+|\s+$/g,"");try{this[v]=e.parseOne(t)}catch(n){if(!(n instanceof e.Error))throw this[v]=s,n;this[v]=n}return t},_initializePieceSymbols:function(e){var n=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(e)){e=e.toUpperCase(),this[f]={};for(var r=0;r<6;++r)this[f][n[r]]=e.substr(r+1,1)}else if(/^:\w+$/.test(e)){var i=Et(e.substr(1));e=":"+i.font,this[f]=i[K]}else switch(e){case"figurines":this[f]=Et(t[w].chessFont)[K];break;case"localized":this[f]={};for(var r=0;r<6;++r){var s=n[r];this[f][s]=s in t[w].i18n[rt]?t[w].i18n[rt][s]:s}break;default:this[f]={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},e="native"}return e},_destroyContent:function(){var e=t(p,this[a]);e[x]!==0&&t(i)[W]("close"),this[a].empty()},_refresh:function(){this[G]();if(this[v]===s)return;if(this[v]instanceof e.Error){t(this._buildErrorMessage())[tt](this[a]);return}var n="";n+=this[X]("White"),n+=this[X]("Black"),n+=this._eventHeader(),n+=this._datePlaceHeader(),n+=this._annotatorHeader(),n!==""&&(n='<div class="uichess-chessgame-headers">'+n+l);var i=this._buildInitialMove(),o=this._buildBody(),f="",c="";switch(this[u][r]){case Q:case J:c=L+this[u][r][j]("float","clear")+'"></div>',f='<div class="uichess-chessgame-navigationBox uichess-chessgame-'+this[u][r]+H+Tt()+l}t(f+i+n+o+c)[tt](this[a]),this._makeDiagrams(),this[u][r]!==U&&(this._makeMovesClickable(),this._makeMovesRelated(),this[u][r]!==A&&this._makeNavigationBoxWidgets())},_makeDiagrams:function(){var e=this;t(".uichess-chessgame-comment .uichess-chessgame-diagramAnchor",this[a]).each(function(n,r){var i=t(r),s=i.closest(".uichess-chessgame-comment")[_](g),o={position:s,flip:e[u][at]};t.extend(o,e[u][T]);try{t.extend(o,St(t.parseJSON(i.text())))}catch(a){}i.empty()[z]("uichess-chessgame-diagramAnchor")[Z]("uichess-chessgame-diagram")[S](o)})},_makeMovesClickable:function(){var e=this;t(E,this[a])[$](function(){e[c](t(this))})},_makeMovesRelated:function(){t(".uichess-chessgame-variation").each(function(e,n){var r=t(n),i=r.is("div")?r[ut](".uichess-chessgame-moveGroup")[ut](E):r[ut](E),o=s;i.each(function(e,n){var r=t(n);o!==s&&(r[_](N,o),o[_](C,r)),o=r})});var e=t(O,this[a]),n=t(".uichess-chessgame-variation .uichess-chessgame-move",this[a]);if(n[x]!==0){var r=n.first();r[_](N,e),e[_](C,r)}},_makeNavigationBoxWidgets:function(){t(k,this[a])[S](this[u][y]);var e=this;t(".uichess-chessgame-navigationButtonFrst",this[a])[$](function(t){t[d](),e[st]()}),t(".uichess-chessgame-navigationButtonPrev",this[a])[$](function(t){t[d](),e[Y]()}),t(".uichess-chessgame-navigationButtonNext",this[a])[$](function(t){t[d](),e[lt]()}),t(".uichess-chessgame-navigationButtonLast",this[a])[$](function(t){t[d](),e[ot]()}),this[c](t(O,this[a]))},_buildErrorMessage:function(){var e='<div class="uichess-chessgame-error"><div class="uichess-chessgame-errorTitle">Error while analysing a PGN string.</div>';return this[v].message!==s&&(e+='<div class="uichess-chessgame-errorMessage">'+this[v].message+l),this[v].pos!==s&&this[v].pos>=0&&(e+='<div class="uichess-chessgame-errorAt">',this[v].pos>=this[v].pgnString[x]?e+="Occurred at the end of the string.":e+="Occurred at position "+this[v].pos+":"+'<div class="uichess-chessgame-errorAtCode">'+yt(this[v].pgnString,this[v].pos,10,40)+l,e+=l),e+=l,e},_playerNameHeader:function(e){var t=ct(this[v][F](e));if(t===s)return"";var n=L+e.toLowerCase()+'Player">'+'<span class="uichess-chessgame-colorTag"></span> '+'<span class="uichess-chessgame-playerName">'+t+h,r=dt(this[v][F](e+"Title")),i=ct(this[v][F](e+"Elo"));if(r!==s||i!==s)n+='<span class="uichess-chessgame-titleRatingGroup">',r!==s&&(n+='<span class="uichess-chessgame-playerTitle">'+r+h),i!==s&&(n+='<span class="uichess-chessgame-playerRating">'+i+h),n+=h;return n+=l,n},_eventHeader:function(){var e=ct(this[v][F]("Event"));if(e===s)return"";var t=ct(this[v][F]("Round")),n='<div class="uichess-chessgame-event">'+e;return t!==s&&(n+='<span class="uichess-chessgame-round">'+t+h),n+=l,n},_datePlaceHeader:function(){var e=ht(this[v][F]("Date")),t=ct(this[v][F]("Site"));if(e===s&&t===s)return"";var n='<div class="uichess-chessgame-datePlaceGroup">';return e!==s&&(n+='<span class="uichess-chessgame-date">'+e+h),t!==s&&(n+='<span class="uichess-chessgame-site">'+t+h),n+=l,n},_annotatorHeader:function(){var e=ct(this[v][F]("Annotator"));if(e===s)return"";var n='<div class="uichess-chessgame-annotator">'+t[w].i18n.ANNOTATED_BY[j](/%1\$s/g,'<span class="uichess-chessgame-annotatorName">'+e+h)+l;return n},_buildBody:function(){var e=this[it](this[v].mainVariation(),!0,pt(this[v].result()));if(e.content==="")return"";var t="uichess-chessgame-body";return e.divCount>1&&(t+=" uichess-chessgame-moreSpace"),this[u][r]!==U&&(t+=" uichess-chessgame-clickableMoves"),'<div class="'+t+H+e.content+l},_buildVariation:function(e,t,n){function f(){o&&!u&&(i+='<div class="uichess-chessgame-moveGroup">',u=!0,++a)}function c(){u&&(i+=l,u=q)}if(e[V]()===s&&e.first()===s&&n===s)return t?{content:"",divCount:0}:"";var r=e[D]()?"div":"span",i="<"+r+' class="uichess-chessgame-variation'+(t?"":" uichess-chessgame-subVariation")+H,o=e[D](),u=q,a=0;e[V]()!==s&&(e[R]()?++a:f(),i+=this[ft](e));var p=!0,d=e.first();while(d!==s){f(),i+=this._buildMove(d,p),d[V]()!==s&&(d[R]()&&(c(),++a),i+=this[ft](d));var v=0;for(var m=0;m<d.variations();++m){var g=this[it](d.variation(m),q,s);g!==""&&(d.variation(m)[D]()?(c(),++a):f(),i+=g,++v)}p=d[V]()!==s||v>0,d=d.next()}return t&&n!==s&&(f(),i+='<span class="uichess-chessgame-result">'+n+h),c(),i+="</"+r+">",t?{content:i,divCount:a}:i},_buildComment:function(e){var t=e[R]()?"div":"span";return"<"+t+' class="uichess-chessgame-comment" data-position="'+e[g]()+H+e[V]()+"</"+t+">"},_buildMove:function(e,t){var n='<span class="uichess-chessgame-move" data-position="'+e[g]()+H,r=t||e.moveColor()==="w",i="uichess-chessgame-moveNumber"+(r?"":" uichess-chessgame-hidden"),s=e.fullMoveNumber()+(e.moveColor()==="w"?".":"…");n+='<span class="'+i+H+s+h;var o=this[f];n+=e.move()[j](/[KQRBNP]/g,function(e){return o[e]});var u=e.nags();for(var a=0;a<u[x];++a)n+=" "+mt(u[a]);return n+=h,n},_buildInitialMove:function(){return'<div class="uichess-chessgame-move uichess-chessgame-initialMove" data-position="'+this[v].initialPosition()+H+t[w].i18n.INITIAL_POSITION+l},_updateNavigationBoard:function(e){if(e===undefined||e===s||e.hasClass(b))return;this[u][r]===A&&Nt(),this._updateNavigationBoardWidget(e),this._updateSelectedMove(e);if(this[u][r]===A){var n=t(i);n[W]("isOpen")||(n[W](I,g,{my:"center",at:"center",of:window}),n[W]("open")),t(".ui-dialog-title",n.closest(".ui-dialog")).empty().append(e.html())}},_updateNavigationBoardWidget:function(e){var n=this[u][r]===A?t(m):t(k,this[a]);n[S](I,g,e[_](g)),this[u][at]!==n[S](I,at)&&n[S](I,at,this[u][at])},_updateSelectedMove:function(e){var n=this[u][r]===A;xt(n?s:t(o,this[a])),e[Z](b),n&&e.attr("id","uichess-chessgame-navigationFrameTarget");var i=e.css("color");e.css("background-color",i),e.css("color",bt(i))}})})(Pgn,jQuery,moment);