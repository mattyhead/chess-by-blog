!function(e,s,i){"use strict";function a(e){return null===e||"?"===e?null:e}function t(e){if(null===e||"????.??.??"===e)return null;if(e.match(/([0-9]{4})\.([0-9]{2})\.([0-9]{2})/)){var s=i(RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3);return s.isValid()?r(s.format("LL")):e}if(e.match(/([0-9]{4})\.([0-9]{2})\.\?\?/)){var s=i(RegExp.$1+"-"+RegExp.$2+"-01");return s.isValid()?r(s.format("MMMM YYYY")):e}return e.match(/([0-9]{4})\.\?\?\.\?\?/)?RegExp.$1:e}function n(e){switch(e){case null:case"*":return null;case"1/2-1/2":return"&#189;&#8211;&#189;";case"1-0":return"1&#8211;0";case"0-1":return"0&#8211;1";default:return e}}function o(e){return null===e||"-"===e?null:e}function c(e){return null===e?null:e in f?f[e]:"$"+e}function r(e){return 0===e.length?"":e.charAt(0).toUpperCase()+e.slice(1)}function h(e,s,i,a){var t=s-i,n="...";0>=t&&(t=0,n="");var o=s+1+a,c="...";o>=e.length&&(o=e.length,c="");var r=n+e.substr(t,o-t)+c;return r=r.replace(/\n|\t/g," "),r+"\n"+new Array(1+n.length+s-t).join(" ")+"^"}function l(e){var i=s.Color(e);return i.lightness()>.5?"black":"white"}function u(e){switch(e){case"frame":case"floatLeft":case"floatRight":return e;default:return"none"}}function g(e){switch(e){case"merida":case"pirat":break;default:e="alpha"}var s='<span class="uichess-chessgame-'+e+'Font">',i="</span>",a={K:s+"K"+i,Q:s+"Q"+i,R:s+"R"+i,B:s+"B"+i,N:s+"N"+i,P:s+"P"+i};return{font:e,pieceSymbolTable:a}}function m(e){return{squareSize:e.squareSize,showCoordinates:e.showCoordinates}}function v(e){(void 0===e||null===e)&&(e=s("#uichess-chessgame-navigationFrameTarget")),e.attr("style",null).attr("id",null).removeClass("uichess-chessgame-selectedMove")}function d(){return'<div class="uichess-chessgame-navigationBoard"></div><div class="uichess-chessgame-navigationButtons"><button class="uichess-chessgame-navigationButtonFrst">&lt;&lt;</button><button class="uichess-chessgame-navigationButtonPrev">&lt;</button><button class="uichess-chessgame-navigationButtonNext">&gt;</button><button class="uichess-chessgame-navigationButtonLast">&gt;&gt;</button></div>'}function p(){function e(e){s("#uichess-chessgame-navigationFrameTarget").closest(".uichess-chessgame").chessgame(e)}if(0===s("#uichess-chessgame-navigationFrame").length){s('<div id="uichess-chessgame-navigationFrame">'+d()+"</div>").appendTo(s("body")),s("#uichess-chessgame-navigationFrame").dialog({create:function(e){s(e.target).parent().css("position","fixed")},resizeStart:function(e){s(e.target).parent().css("position","fixed")},resizeStop:function(e){s(e.target).parent().css("position","fixed")},autoOpen:!1,dialogClass:s.chessgame.navigationFrameClass,width:"auto",close:function(){v()}});var i=s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationBoard");i.chessboard(m(s.chessgame.navigationFrameOptions)),i.chessboard("sizeControlledByContainer",s("#uichess-chessgame-navigationFrame"),"dialogresize"),s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonFrst").click(function(s){s.preventDefault(),e("goFirstMove")}),s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonPrev").click(function(s){s.preventDefault(),e("goPreviousMove")}),s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonNext").click(function(s){s.preventDefault(),e("goNextMove")}),s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonLast").click(function(s){s.preventDefault(),e("goLastMove")})}}s.chessgame={navigationFrameOptions:{},navigationFrameClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"}}};var f={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};s.widget("uichess.chessgame",{options:{pgn:"*",navigationBoard:"none",navigationBoardOptions:{},diagramOptions:{},flip:!1,pieceSymbols:"native"},_game:null,_pieceSymbolTable:null,_create:function(){this.element.addClass("uichess-chessgame"),this.options.pgn=this._initializePGN(this.options.pgn),this.options.pieceSymbols=this._initializePieceSymbols(this.options.pieceSymbols),this.options.navigationBoard=u(this.options.navigationBoard),this.options.navigationBoardOptions=m(this.options.navigationBoardOptions),this.options.diagramOptions=m(this.options.diagramOptions),this._refresh()},_destroy:function(){this._destroyContent(),this.element.removeClass("uichess-chessgame")},_setOption:function(e,s){switch(e){case"pgn":s=this._initializePGN(s);break;case"pieceSymbols":s=this._initializePieceSymbols(s);break;case"navigationBoard":s=u(s);break;case"navigationBoardOptions":s=m(s);break;case"diagramOptions":s=m(s)}this.options[e]=s,this._refresh()},goFirstMove:function(){var e=s(".uichess-chessgame-selectedMove",this.element);if(0!==e.length){for(;void 0!==e.data("prevMove");)e=e.data("prevMove");this._updateNavigationBoard(e)}},goPreviousMove:function(){this._updateNavigationBoard(s(".uichess-chessgame-selectedMove",this.element).data("prevMove"))},goNextMove:function(){this._updateNavigationBoard(s(".uichess-chessgame-selectedMove",this.element).data("nextMove"))},goLastMove:function(){var e=s(".uichess-chessgame-selectedMove",this.element);if(0!==e.length){for(;void 0!==e.data("nextMove");)e=e.data("nextMove");this._updateNavigationBoard(e)}},_initializePGN:function(s){"string"!=typeof s&&(s="*"),s=s.replace(/^\s+|\s+$/g,"");try{this._game=e.parseOne(s)}catch(i){if(!(i instanceof e.Error))throw this._game=null,i;this._game=i}return s},_initializePieceSymbols:function(e){var i=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(e)){e=e.toUpperCase(),this._pieceSymbolTable={};for(var a=0;6>a;++a)this._pieceSymbolTable[i[a]]=e.substr(a+1,1)}else if(/^:\w+$/.test(e)){var t=g(e.substr(1));e=":"+t.font,this._pieceSymbolTable=t.pieceSymbolTable}else switch(e){case"figurines":this._pieceSymbolTable=g(s.chessgame.chessFont).pieceSymbolTable;break;case"localized":this._pieceSymbolTable={};for(var a=0;6>a;++a){var n=i[a];this._pieceSymbolTable[n]=n in s.chessgame.i18n.PIECE_SYMBOLS?s.chessgame.i18n.PIECE_SYMBOLS[n]:n}break;default:this._pieceSymbolTable={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},e="native"}return e},_destroyContent:function(){var e=s("#uichess-chessgame-navigationFrameTarget",this.element);0!==e.length&&s("#uichess-chessgame-navigationFrame").dialog("close"),this.element.empty()},_refresh:function(){if(this._destroyContent(),null!==this._game){if(this._game instanceof e.Error)return void s(this._buildErrorMessage()).appendTo(this.element);var i="";i+=this._playerNameHeader("White"),i+=this._playerNameHeader("Black"),i+=this._eventHeader(),i+=this._datePlaceHeader(),i+=this._annotatorHeader(),""!==i&&(i='<div class="uichess-chessgame-headers">'+i+"</div>");var a=this._buildInitialMove(),t=this._buildBody(),n="",o="";switch(this.options.navigationBoard){case"floatLeft":case"floatRight":o='<div class="uichess-chessgame-'+this.options.navigationBoard.replace("float","clear")+'"></div>',n='<div class="uichess-chessgame-navigationBox uichess-chessgame-'+this.options.navigationBoard+'">'+d()+"</div>"}s(n+a+i+t+o).appendTo(this.element),this._makeDiagrams(),"none"!==this.options.navigationBoard&&(this._makeMovesClickable(),this._makeMovesRelated(),"frame"!==this.options.navigationBoard&&this._makeNavigationBoxWidgets())}},_makeDiagrams:function(){var e=this;s(".uichess-chessgame-comment .uichess-chessgame-diagramAnchor",this.element).each(function(i,a){var t=s(a),n=t.closest(".uichess-chessgame-comment").data("position"),o={position:n,flip:e.options.flip};s.extend(o,e.options.diagramOptions);try{s.extend(o,m(s.parseJSON(t.text())))}catch(c){}t.empty().removeClass("uichess-chessgame-diagramAnchor").addClass("uichess-chessgame-diagram").chessboard(o)})},_makeMovesClickable:function(){var e=this;s(".uichess-chessgame-move",this.element).click(function(){e._updateNavigationBoard(s(this))})},_makeMovesRelated:function(){s(".uichess-chessgame-variation").each(function(e,i){var a=s(i),t=a.is("div")?a.children(".uichess-chessgame-moveGroup").children(".uichess-chessgame-move"):a.children(".uichess-chessgame-move"),n=null;t.each(function(e,i){var a=s(i);null!==n&&(a.data("prevMove",n),n.data("nextMove",a)),n=a})});var e=s(".uichess-chessgame-initialMove",this.element),i=s(".uichess-chessgame-variation .uichess-chessgame-move",this.element);if(0!==i.length){var a=i.first();a.data("prevMove",e),e.data("nextMove",a)}},_makeNavigationBoxWidgets:function(){s(".uichess-chessgame-navigationBoard",this.element).chessboard(this.options.navigationBoardOptions);var e=this;s(".uichess-chessgame-navigationButtonFrst",this.element).click(function(s){s.preventDefault(),e.goFirstMove()}),s(".uichess-chessgame-navigationButtonPrev",this.element).click(function(s){s.preventDefault(),e.goPreviousMove()}),s(".uichess-chessgame-navigationButtonNext",this.element).click(function(s){s.preventDefault(),e.goNextMove()}),s(".uichess-chessgame-navigationButtonLast",this.element).click(function(s){s.preventDefault(),e.goLastMove()}),this._updateNavigationBoard(s(".uichess-chessgame-initialMove",this.element))},_buildErrorMessage:function(){var e='<div class="uichess-chessgame-error"><div class="uichess-chessgame-errorTitle">Error while analysing a PGN string.</div>';return null!==this._game.message&&(e+='<div class="uichess-chessgame-errorMessage">'+this._game.message+"</div>"),null!==this._game.pos&&this._game.pos>=0&&(e+='<div class="uichess-chessgame-errorAt">',e+=this._game.pos>=this._game.pgnString.length?"Occurred at the end of the string.":"Occurred at position "+this._game.pos+':<div class="uichess-chessgame-errorAtCode">'+h(this._game.pgnString,this._game.pos,10,40)+"</div>",e+="</div>"),e+="</div>"},_playerNameHeader:function(e){var s=a(this._game.header(e));if(null===s)return"";var i='<div class="uichess-chessgame-'+e.toLowerCase()+'Player"><span class="uichess-chessgame-colorTag"></span> <span class="uichess-chessgame-playerName">'+s+"</span>",t=o(this._game.header(e+"Title")),n=a(this._game.header(e+"Elo"));return(null!==t||null!==n)&&(i+='<span class="uichess-chessgame-titleRatingGroup">',null!==t&&(i+='<span class="uichess-chessgame-playerTitle">'+t+"</span>"),null!==n&&(i+='<span class="uichess-chessgame-playerRating">'+n+"</span>"),i+="</span>"),i+="</div>"},_eventHeader:function(){var e=a(this._game.header("Event"));if(null===e)return"";var s=a(this._game.header("Round")),i='<div class="uichess-chessgame-event">'+e;return null!==s&&(i+='<span class="uichess-chessgame-round">'+s+"</span>"),i+="</div>"},_datePlaceHeader:function(){var e=t(this._game.header("Date")),s=a(this._game.header("Site"));if(null===e&&null===s)return"";var i='<div class="uichess-chessgame-datePlaceGroup">';return null!==e&&(i+='<span class="uichess-chessgame-date">'+e+"</span>"),null!==s&&(i+='<span class="uichess-chessgame-site">'+s+"</span>"),i+="</div>"},_annotatorHeader:function(){var e=a(this._game.header("Annotator"));if(null===e)return"";var i='<div class="uichess-chessgame-annotator">'+s.chessgame.i18n.ANNOTATED_BY.replace(/%1\$s/g,'<span class="uichess-chessgame-annotatorName">'+e+"</span>")+"</div>";return i},_buildBody:function(){var e=this._buildVariation(this._game.mainVariation(),!0,n(this._game.result()));if(""===e.content)return"";var s="uichess-chessgame-body";return e.divCount>1&&(s+=" uichess-chessgame-moreSpace"),"none"!==this.options.navigationBoard&&(s+=" uichess-chessgame-clickableMoves"),'<div class="'+s+'">'+e.content+"</div>"},_buildVariation:function(e,s,i){function a(){c&&!r&&(o+='<div class="uichess-chessgame-moveGroup">',r=!0,++h)}function t(){r&&(o+="</div>",r=!1)}if(null===e.comment()&&null===e.first()&&null===i)return s?{content:"",divCount:0}:"";var n=e.isLongVariation()?"div":"span",o="<"+n+' class="uichess-chessgame-variation'+(s?"":" uichess-chessgame-subVariation")+'">',c=e.isLongVariation(),r=!1,h=0;null!==e.comment()&&(e.isLongComment()?++h:a(),o+=this._buildComment(e));for(var l=!0,u=e.first();null!==u;){a(),o+=this._buildMove(u,l),null!==u.comment()&&(u.isLongComment()&&(t(),++h),o+=this._buildComment(u));for(var g=0,m=0;m<u.variations();++m){var v=this._buildVariation(u.variation(m),!1,null);""!==v&&(u.variation(m).isLongVariation()?(t(),++h):a(),o+=v,++g)}l=null!==u.comment()||g>0,u=u.next()}return s&&null!==i&&(a(),o+='<span class="uichess-chessgame-result">'+i+"</span>"),t(),o+="</"+n+">",s?{content:o,divCount:h}:o},_buildComment:function(e){var s=e.isLongComment()?"div":"span";return"<"+s+' class="uichess-chessgame-comment" data-position="'+e.position()+'">'+e.comment()+"</"+s+">"},_buildMove:function(e,s){var i='<span class="uichess-chessgame-move" data-position="'+e.position()+'">',a=s||"w"===e.moveColor(),t="uichess-chessgame-moveNumber"+(a?"":" uichess-chessgame-hidden"),n=e.fullMoveNumber()+("w"===e.moveColor()?".":"…");i+='<span class="'+t+'">'+n+"</span>";var o=this._pieceSymbolTable;i+=e.move().replace(/[KQRBNP]/g,function(e){return o[e]});for(var r=e.nags(),h=0;h<r.length;++h)i+=" "+c(r[h]);return i+="</span>"},_buildInitialMove:function(){return'<div class="uichess-chessgame-move uichess-chessgame-initialMove" data-position="'+this._game.initialPosition()+'">'+s.chessgame.i18n.INITIAL_POSITION+"</div>"},_updateNavigationBoard:function(e){if(void 0!==e&&null!==e&&!e.hasClass("uichess-chessgame-selectedMove")&&("frame"===this.options.navigationBoard&&p(),this._updateNavigationBoardWidget(e),this._updateSelectedMove(e),"frame"===this.options.navigationBoard)){var i=s("#uichess-chessgame-navigationFrame");i.dialog("isOpen")||(i.dialog("option","position",{my:"center",at:"center",of:window}),i.dialog("open")),s(".ui-dialog-title",i.closest(".ui-dialog")).empty().append(e.html())}},_updateNavigationBoardWidget:function(e){var i="frame"===this.options.navigationBoard?s("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationBoard"):s(".uichess-chessgame-navigationBoard",this.element);i.chessboard("option","position",e.data("position")),this.options.flip!==i.chessboard("option","flip")&&i.chessboard("option","flip",this.options.flip)},_updateSelectedMove:function(e){var i="frame"===this.options.navigationBoard;v(i?null:s(".uichess-chessgame-selectedMove",this.element)),e.addClass("uichess-chessgame-selectedMove"),i&&e.attr("id","uichess-chessgame-navigationFrameTarget");var a=e.css("color");e.css("background-color",a),e.css("color",l(a))}})}(Pgn,jQuery,moment);